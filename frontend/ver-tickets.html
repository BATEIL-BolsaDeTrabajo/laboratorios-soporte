<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Tickets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <div id="navbar-container"></div>

  <div class="container py-5">
    <h2 class="mb-4 text-center">Gestión de Tickets</h2>

    <div id="tickets" class="row g-3"></div>
  </div>
  <script>
  // Proteger acceso: si no hay token, redirige a login
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "login.html";
  }

  // Función para cerrar sesión
  function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
  }

  async function cargarTickets() {
    const res = await fetch("/api/tickets", {
      headers: { Authorization: `Bearer ${token}` }
    });

    const datos = await res.json();
    const contenedor = document.getElementById("tickets");
    contenedor.innerHTML = "";

    datos.forEach(ticket => {
      const div = document.createElement("div");
      div.className = "col-md-6";

      div.innerHTML = `
        <div class="card border-${colorPorEstatus(ticket.estatus)}">
          <div class="card-body">
            <h5 class="card-title">Área: ${ticket.tipo}</h5>
            <p class="card-text">
              Descripción: ${ticket.descripcion}<br>
              Estatus: <strong>${ticket.estatus}</strong><br>
              Creado por: ${ticket.creadoPor?.nombre || "N/A"}<br>
              Asignado a: ${ticket.asignadoA?.nombre || "Sin asignar"}
            </p>

            <select class="form-select mb-2" id="estatus-${ticket._id}">
              <option ${ticket.estatus === 'Abierto' ? 'selected' : ''}>Abierto</option>
              <option ${ticket.estatus === 'En proceso' ? 'selected' : ''}>En proceso</option>
              <option ${ticket.estatus === 'Resuelto' ? 'selected' : ''}>Resuelto</option>
              <option ${ticket.estatus === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
            </select>

            <input type="text" id="material-${ticket._id}" class="form-control mb-2" placeholder="Material requerido (opcional)" value="${ticket.requiereMaterial || ''}" />

            <button class="btn btn-primary w-100 mb-2" onclick="actualizarTicket('${ticket._id}')">Guardar cambios</button>
            ${!ticket.asignadoA ? `<button class="btn btn-success w-100" onclick="asignarmeTicket('${ticket._id}')">Asignarme</button>` : ''}
          </div>
        </div>
      `;
      contenedor.appendChild(div);
    });
  }

  function colorPorEstatus(estatus) {
    switch (estatus) {
      case 'Abierto': return 'secondary';
      case 'En proceso': return 'warning';
      case 'Resuelto': return 'success';
      case 'Cerrado': return 'dark';
      default: return 'light';
    }
  }

  async function actualizarTicket(id) {
    const estatus = document.getElementById(`estatus-${id}`).value;
    const requiereMaterial = document.getElementById(`material-${id}`).value;

    const res = await fetch(`/api/tickets/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ estatus, requiereMaterial })
    });

    const data = await res.json();
    alert(data.mensaje);
    cargarTickets();
  }

  async function asignarmeTicket(id) {
    const res = await fetch(`/api/tickets/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ asignar: true })
    });

    const data = await res.json();
    alert(data.mensaje);
    cargarTickets();
  }

  // Al cargar la página
  cargarTickets();
</script>
  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>