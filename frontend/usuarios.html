<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrar Usuarios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
 <!-- Menú de navegación del admin -->
 
  <div id="navbar-container"></div>

<body class="bg-light">
  <div class="container py-4">
    <h2 class="text-center mb-4">Administrar Usuarios</h2>
    <div id="usuarios" class="table-responsive"></div>
  </div>

  <script>
  // Verificar si hay token
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "login.html";
  }

  // Función para cerrar sesión
  function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
  }

  // Cargar usuarios desde backend
  async function cargarUsuarios() {
    const res = await fetch("/api/users", {
      headers: { Authorization: `Bearer ${token}` }
    });

    const usuarios = await res.json();
    const contenedor = document.getElementById("usuarios");

    let tabla = `
      <table class="table table-bordered table-striped align-middle text-center">
        <thead class="table-dark">
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Roles</th>
            <th>Nueva Contraseña</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
    `;

    usuarios.forEach(usuario => {
      tabla += `
        <tr>
          <td>${usuario.nombre}</td>
          <td>${usuario.correo}</td>
          <td>
            ${crearCheckbox(usuario._id, 'docente', usuario.roles)}
            ${crearCheckbox(usuario._id, 'soporte', usuario.roles)}
            ${crearCheckbox(usuario._id, 'mantenimiento', usuario.roles)}
            ${crearCheckbox(usuario._id, 'admin', usuario.roles)}
            ${crearCheckbox(usuario._id, 'rrhh', usuario.roles)}
            ${crearCheckbox(usuario._id, 'direccion', usuario.roles)}
            ${crearCheckbox(usuario._id, 'subdireccion', usuario.roles)}
            ${crearCheckbox(usuario._id, 'almacen', usuario.roles)}
            ${crearCheckbox(usuario._id, 'finanzas', usuario.roles)}
            ${crearCheckbox(usuario._id, 'coordinacionD', usuario.roles)}
          </td>
          <td>
            <input type="password" class="form-control" id="pass-${usuario._id}" placeholder="Nueva contraseña">
          </td>
          <td>
            <button class="btn btn-primary" onclick="guardarCambios('${usuario._id}')">Guardar</button>
          </td>
        </tr>
      `;
    });

    tabla += '</tbody></table>';
    contenedor.innerHTML = tabla;
  }

  function crearCheckbox(id, rol, rolesUsuario) {
    const checked = rolesUsuario.includes(rol) ? 'checked' : '';
    return `
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="${rol}-${id}" value="${rol}" ${checked}>
        <label class="form-check-label" for="${rol}-${id}">${rol}</label>
      </div>
    `;
  }

  async function guardarCambios(id) {
    const checkboxes = document.querySelectorAll(`input[type="checkbox"][id$="-${id}"]:checked`);
    const roles = Array.from(checkboxes).map(cb => cb.value);

    const nuevaContraseña = document.getElementById(`pass-${id}`).value;

    const body = { roles };
    if (nuevaContraseña.trim() !== "") {
      body.nuevaContraseña = nuevaContraseña;
    }

    const res = await fetch(`/api/users/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    alert(data.mensaje || "Usuario actualizado");

    // Limpia el campo de contraseña después de guardar
    document.getElementById(`pass-${id}`).value = "";
  }

  cargarUsuarios();
</script>
  <script src="js/navbar.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>