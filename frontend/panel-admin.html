<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Paleta KPI */
    .kpi { border-radius:14px; padding:16px; text-align:center; }
    .kpi .label { font-weight:600; opacity:.9; }
    .kpi .value { font-size:2rem; font-weight:700; line-height:1; }
    .kpi-total    { background:#1E73FF; color:#fff; }  /* Total: azul */
    .kpi-abiertos { background:#FF9800; color:#fff; }  /* Abiertos: naranja */
    .kpi-proceso  { background:#FFC107; color:#111; }  /* En proceso: amarillo */
    .kpi-espera   { background:#9E9E9E; color:#fff; }  /* En espera: gris */
    .kpi-resueltos{ background:#03A9F4; color:#fff; }  /* Resueltos: azul cielo */
    .kpi-cerrados { background:#4CAF50; color:#fff; }  /* Cerrados: verde */
    .kpi-excedido { background:#E53935; color:#fff; }  /* Tiempo excedido: rojo */

    /* Colores de tarjetas por estatus */
    .card-estatus-Abierto              { border-color:#FF9800 !important; background:#FF9800; color:#fff; }
    .card-estatus-En\ proceso          { border-color:#FFC107 !important; background:#FFC107; color:#111; }
    .card-estatus-En\ espera\ de\ material { border-color:#9E9E9E !important; background:#9E9E9E; color:#fff; }
    .card-estatus-Resuelto             { border-color:#03A9F4 !important; background:#03A9F4; color:#fff; }
    .card-estatus-Cerrado              { border-color:#4CAF50 !important; background:#4CAF50; color:#fff; }
    .card-estatus-Tiempo\ excedido     { border-color:#E53935 !important; background:#E53935; color:#fff; }
  </style>
</head>
<body class="bg-light">
  <div id="navbar-container"></div>

  <div class="container py-4">
    <h2 class="text-center mb-4">Panel de Administración - Tickets</h2>

    <div class="row mb-4 g-3">
      <div class="col-md-4">
        <label class="form-label">Filtrar por tipo</label>
        <select id="filtroTipo" class="form-select" onchange="cargarTickets()">
          <option value="">Todos</option>
          <option value="Sistemas">Sistemas</option>
          <option value="Mantenimiento">Mantenimiento</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Filtrar por estatus</label>
        <select id="filtroEstatus" class="form-select" onchange="cargarTickets()">
          <option value="">Todos</option>
          <option>Abierto</option>
          <option>En proceso</option>
          <option>En espera de material</option>
          <option>Resuelto</option>
          <option>Cerrado</option>
          <option>Tiempo excedido</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Filtrar por prioridad</label>
        <select id="filtroPrioridad" class="form-select" onchange="cargarTickets()">
          <option value="">Todas</option>
          <option>Alta</option>
          <option>Media</option>
          <option>Baja</option>
        </select>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4" id="kpis">
      <div class="col-6 col-md-2"><div class="kpi kpi-total"><div class="label">Total</div><div id="kpi-total" class="value">0</div></div></div>
      <div class="col-6 col-md-2"><div class="kpi kpi-abiertos"><div class="label">Abiertos</div><div id="kpi-abiertos" class="value">0</div></div></div>
      <div class="col-6 col-md-2"><div class="kpi kpi-proceso"><div class="label">En proceso</div><div id="kpi-proceso" class="value">0</div></div></div>
      <div class="col-6 col-md-2"><div class="kpi kpi-espera"><div class="label">En espera</div><div id="kpi-espera" class="value">0</div></div></div>
      <div class="col-6 col-md-2"><div class="kpi kpi-resueltos"><div class="label">Resueltos</div><div id="kpi-resueltos" class="value">0</div></div></div>
      <div class="col-6 col-md-2"><div class="kpi kpi-cerrados"><div class="label">Cerrados</div><div id="kpi-cerrados" class="value">0</div></div></div>
      <div class="col-6 col-md-2"><div class="kpi kpi-excedido"><div class="label">Tiempo excedido</div><div id="kpi-excedido" class="value">0</div></div></div>
    </div>

    <div id="mensaje-estado" class="mb-3"></div>
    <div id="tickets" class="row g-3"></div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    // Colores por estatus (actualizados a la paleta)
    const estatusColor = {
      "Abierto":             { border: "light", bg: "card-estatus-Abierto"               , text: "" },
      "En proceso":          { border: "light", bg: "card-estatus-En proceso"            , text: "" },
      "En espera de material":{ border: "light", bg: "card-estatus-En espera de material", text: "" },
      "Resuelto":            { border: "light", bg: "card-estatus-Resuelto"              , text: "" },
      "Cerrado":             { border: "light", bg: "card-estatus-Cerrado"               , text: "" },
      "Tiempo excedido":     { border: "light", bg: "card-estatus-Tiempo excedido"       , text: "" }
    };

    // Badge por prioridad
    const prioridadBadge = (p) => {
      const map = { 'Alta': 'danger', 'Media': 'warning', 'Baja': 'secondary' };
      const cls = map[p] || 'secondary';
      return `<span class="badge bg-${cls}">${p || 'Media'}</span>`;
    };

    let usuarios = [];

    async function obtenerUsuarios() {
      try {
        const res = await fetch("/api/users", { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();

        if (!Array.isArray(data)) {
          console.error("⚠ Error al obtener usuarios:", data);
          mostrarMensaje("❌ No se pudieron cargar los usuarios", "danger");
          return false;
        }
        usuarios = data;
        return true;
      } catch (error) {
        console.error("❌ Error inesperado al cargar usuarios:", error);
        mostrarMensaje("❌ Error al conectar con el servidor", "danger");
        return false;
      }
    }

    function actualizarKPIs(lista){
      const by = (st) => lista.filter(t => t.estatus === st).length;
      document.getElementById('kpi-total').textContent     = lista.length;
      document.getElementById('kpi-abiertos').textContent  = by('Abierto');
      document.getElementById('kpi-proceso').textContent   = by('En proceso');
      document.getElementById('kpi-espera').textContent    = by('En espera de material');
      document.getElementById('kpi-resueltos').textContent = by('Resuelto');
      document.getElementById('kpi-cerrados').textContent  = by('Cerrado');
      document.getElementById('kpi-excedido').textContent  = by('Tiempo excedido');
    }

    async function cargarTickets() {
      const usuariosOK = await obtenerUsuarios();
      if (!usuariosOK) return;

      const tipo      = document.getElementById("filtroTipo").value;
      const estatus   = document.getElementById("filtroEstatus").value;
      const prioridad = document.getElementById("filtroPrioridad").value;

      const res = await fetch("/api/tickets", { headers: { Authorization: `Bearer ${token}` } });
      const datos = await res.json();
      const contenedor = document.getElementById("tickets");
      contenedor.innerHTML = "";

      let filtrados = datos;
      if (tipo)      filtrados = filtrados.filter(t => t.tipo === tipo);
      if (estatus)   filtrados = filtrados.filter(t => t.estatus === estatus);
      if (prioridad) filtrados = filtrados.filter(t => (t.prioridad || 'Media') === prioridad);

      // KPIs sobre los datos filtrados
      actualizarKPIs(filtrados);

      filtrados.forEach(ticket => {
        const div = document.createElement("div");
        div.className = "col-md-6";

        const puedeAsignar = !ticket.asignadoA && ticket.estatus !== "Cerrado";
        const puedeCerrar  = ticket.estatus !== "Cerrado";

        const candidatos = usuarios.filter(u =>
          (ticket.tipo === "Sistemas" && (u.roles || []).includes("soporte")) ||
          (ticket.tipo === "Mantenimiento" && (u.roles || []).includes("mantenimiento"))
        );

        let asignarHTML = "";
        if (puedeAsignar && candidatos.length) {
          asignarHTML = `
            <label class="form-label mt-2">Asignar a:</label>
            <div class="input-group">
              <select class="form-select" id="select-${ticket._id}">
                ${candidatos.map(u => `<option value="${u._id}">${u.nombre}</option>`).join("")}
              </select>
              <button class="btn btn-success" onclick="asignarTicket('${ticket._id}')">Asignar</button>
            </div>
          `;
        }

        let cerrarHTML = "";
        if (puedeCerrar) {
          cerrarHTML = `<button class="btn btn-danger mt-2 w-100" onclick="cerrarTicket('${ticket._id}')">Cerrar ticket</button>`;
        }

        // selector de prioridad + guardar
        const selectorPrioridad = `
          <label class="form-label mt-2">Prioridad:</label>
          <div class="input-group">
            <select class="form-select" id="prio-${ticket._id}">
              ${['Alta','Media','Baja'].map(p => `<option ${(ticket.prioridad||'Media')===p?'selected':''}>${p}</option>`).join('')}
            </select>
            <button class="btn btn-outline-primary" type="button" onclick="guardarPrioridad('${ticket._id}')">
              Guardar
            </button>
            <span class="input-group-text" id="prio-badge-${ticket._id}">
              ${prioridadBadge(ticket.prioridad || 'Media')}
            </span>
          </div>
        `;

        // Botón marcar tiempo excedido (si no está cerrado)
        const btnExcedido = (ticket.estatus !== 'Cerrado')
          ? `<button class="btn btn-outline-danger mt-2 w-100" onclick="marcarExcedido('${ticket._id}')"
                ${ticket.estatus === 'Tiempo excedido' ? 'disabled' : ''}>
                Marcar tiempo excedido
             </button>`
          : '';

        const estilo = estatusColor[ticket.estatus] || { border: 'light', bg: 'bg-light', text: 'text-dark' };

        div.innerHTML = `
          <div class="card border-${estilo.border} ${estilo.bg} ${estilo.text}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <h5 class="card-title mb-1">${ticket.tipo}</h5>
                <div class="text-end small">
                  <div>Estatus: <strong>${ticket.estatus}</strong></div>
                  <div>Prioridad: ${prioridadBadge(ticket.prioridad || 'Media')}</div>
                </div>
              </div>

              <p class="card-text mb-2">
                <span class="text-muted">Folio:</span> <strong>${ticket.folio || '—'}</strong><br>
                Descripción: ${ticket.descripcion}<br>
                Material requerido: ${ticket.requiereMaterial || 'Ninguno'}<br>
                Creado por: ${ticket.creadoPor?.nombre || "N/A"}<br>
                Asignado a: ${ticket.asignadoA?.nombre || "Sin asignar"}<br>
                Fecha: ${new Date(ticket.fechaCreacion || ticket.createdAt).toLocaleString()}
              </p>

              ${selectorPrioridad}
              ${asignarHTML}
              ${btnExcedido}
              ${cerrarHTML}
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    async function asignarTicket(id) {
      const userId = document.getElementById(`select-${id}`).value;

      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ asignadoA: userId })
      });

      const data = await res.json();
      mostrarMensaje(data.mensaje || "✅ Ticket asignado", "success");
      cargarTickets();
    }

    async function cerrarTicket(id) {
      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ estatus: "Cerrado" })
      });

      const data = await res.json();
      mostrarMensaje(data.mensaje || "✅ Ticket cerrado", "success");
      cargarTickets();
    }

    async function marcarExcedido(id){
      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ estatus: "Tiempo excedido" })
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok){ mostrarMensaje(data.mensaje || 'No se pudo marcar como excedido', 'danger'); return; }
      mostrarMensaje('⏰ Ticket marcado como tiempo excedido', 'warning');
      cargarTickets();
    }

    async function guardarPrioridad(id){
      const prio = document.getElementById(`prio-${id}`).value;

      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ prioridad: prio })
      });

      const data = await res.json().catch(()=>({}));
      if (!res.ok){
        mostrarMensaje(data.mensaje || 'No se pudo actualizar la prioridad', 'danger');
        return;
      }

      const badgeHost = document.getElementById(`prio-badge-${id}`);
      if (badgeHost){
        badgeHost.innerHTML = prioridadBadge(prio);
      }

      mostrarMensaje("✅ Prioridad actualizada", "success");
    }

    function mostrarMensaje(texto, tipo = "info") {
      const div = document.getElementById("mensaje-estado");
      div.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${texto}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
      `;
    }

    cargarTickets();
  </script>
  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
