<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div id="navbar-container"></div>

  <div class="container py-4">
    <h2 class="text-center mb-4">Panel de Administración - Tickets</h2>

    <div class="row mb-4">
      <div class="col-md-4">
        <label>Filtrar por tipo</label>
        <select id="filtroTipo" class="form-select" onchange="cargarTickets()">
          <option value="">Todos</option>
          <option value="Sistemas">Sistemas</option>
          <option value="Mantenimiento">Mantenimiento</option>
        </select>
      </div>
      <div class="col-md-4">
        <label>Filtrar por estatus</label>
        <select id="filtroEstatus" class="form-select" onchange="cargarTickets()">
          <option value="">Todos</option>
          <option>Abierto</option>
          <option>En proceso</option>
          <option>Resuelto</option>
          <option>Cerrado</option>
        </select>
      </div>
    </div>

    <div id="tickets" class="row g-3"></div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("usuario");
      window.location.href = "login.html";
    }

    const estatusColor = {
      "Abierto": { border: "success", bg: "bg-success-subtle", text: "text-dark" },
      "En proceso": { border: "warning", bg: "bg-warning-subtle", text: "text-dark" },
      "Resuelto": { border: "danger", bg: "bg-danger-subtle", text: "text-dark" },
      "Cerrado": { border: "dark", bg: "bg-dark", text: "text-white" }
    };

    let usuarios = [];

    async function obtenerUsuarios() {
      const res = await fetch("/api/users", {
        headers: { Authorization: `Bearer ${token}` }
      });
      usuarios = await res.json();
    }

    async function cargarTickets() {
      await obtenerUsuarios();

      const tipo = document.getElementById("filtroTipo").value;
      const estatus = document.getElementById("filtroEstatus").value;

      const res = await fetch("/api/tickets", {
        headers: { Authorization: `Bearer ${token}` }
      });

      const datos = await res.json();
      const contenedor = document.getElementById("tickets");
      contenedor.innerHTML = "";

      let filtrados = datos;
      if (tipo) filtrados = filtrados.filter(t => t.tipo === tipo);
      if (estatus) filtrados = filtrados.filter(t => t.estatus === estatus);

      filtrados.forEach(ticket => {
        const div = document.createElement("div");
        div.className = "col-md-6";

        const puedeAsignar = !ticket.asignadoA && ticket.estatus !== "Cerrado";
        const puedeCerrar = ticket.estatus !== "Cerrado";

        const candidatos = usuarios.filter(u =>
          (ticket.tipo === "Sistemas" && u.roles.includes("soporte")) ||
          (ticket.tipo === "Mantenimiento" && u.roles.includes("mantenimiento"))
        );

        let asignarHTML = "";
        if (puedeAsignar && candidatos.length) {
          asignarHTML = `
            <label class="form-label mt-2">Asignar a:</label>
            <div class="input-group">
              <select class="form-select" id="select-${ticket._id}">
                ${candidatos.map(u => `<option value="${u._id}">${u.nombre}</option>`).join("")}
              </select>
              <button class="btn btn-success" onclick="asignarTicket('${ticket._id}')">Asignar</button>
            </div>
          `;
        }

        let cerrarHTML = "";
        if (puedeCerrar) {
          cerrarHTML = `<button class="btn btn-danger mt-2 w-100" onclick="cerrarTicket('${ticket._id}')">Cerrar ticket</button>`;
        }

        const estilo = estatusColor[ticket.estatus] || { border: 'light', bg: 'bg-light', text: 'text-dark' };

        div.innerHTML = `
          <div class="card border-${estilo.border} ${estilo.bg} ${estilo.text}">
            <div class="card-body">
              <h5 class="card-title">${ticket.tipo}</h5>
              <p class="card-text">
                Descripción: ${ticket.descripcion}<br>
                Estatus: <strong>${ticket.estatus}</strong><br>
                Material requerido: ${ticket.requiereMaterial || 'Ninguno'}<br>
                Creado por: ${ticket.creadoPor?.nombre || "N/A"}<br>
                Asignado a: ${ticket.asignadoA?.nombre || "Sin asignar"}<br>
                Fecha: ${new Date(ticket.fechaCreacion).toLocaleString()}
              </p>
              ${asignarHTML}
              ${cerrarHTML}
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    async function asignarTicket(id) {
      const userId = document.getElementById(`select-${id}`).value;

      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ asignadoA: userId })
      });

      const data = await res.json();
      alert(data.mensaje);
      cargarTickets();
    }

    async function cerrarTicket(id) {
      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ estatus: "Cerrado" })
      });

      const data = await res.json();
      alert(data.mensaje);
      cargarTickets();
    }

    cargarTickets();
  </script>
  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
