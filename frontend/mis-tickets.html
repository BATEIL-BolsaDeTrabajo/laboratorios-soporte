<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color: #f5f5f5; }
    .page-title { display: flex; align-items: center; gap: .75rem; }
    .page-title span.icon {
      width: 40px; height: 40px; border-radius: 999px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 1.4rem; background: #ffc10733;
    }
    .badge-estado { font-size: 0.8rem; }
  </style>
</head>
<body>

<div id="navbar-container"></div>

  <!-- CONTENIDO -->
  <main class="container mb-5">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="page-title">
        <span class="icon">ðŸŽ«</span>
        <div>
          <h1 class="h4 mb-0">Mis tickets</h1>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <label for="filtro-estado" class="col-form-label fw-semibold">
              Filtrar por estado:
            </label>
          </div>
          <div class="col-sm-4 col-md-3">
            <select id="filtro-estado" class="form-select form-select-sm">
              <option value="">Todos</option>
              <option value="Abierto">Abierto</option>
              <option value="En proceso">En proceso</option>
              <option value="En espera de material">En espera de material</option>
              <option value="Resuelto">Resuelto</option>
              <option value="Tiempo excedido">Tiempo excedido</option>
              <option value="Cerrado">Cerrado</option>
              <!-- âœ… NUEVOS -->
              <option value="Archivado">Archivado</option>
              <option value="Rechazado">Rechazado</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th>Folio</th>
                <th>Estado</th>
                <th>Fecha solicitada</th>
                <th>Fecha de inicio</th>
                <th>Fecha de terminado</th>
                <th>DescripciÃ³n del problema</th>
                <th>Comentarios</th>
              </tr>
            </thead>
            <tbody id="tbody-mis-tickets">
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  Cargando tickets...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </main>

  <!-- MODAL: VER COMENTARIOS -->
  <div class="modal fade" id="modalComentariosTicket" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalComentariosTitulo">Comentarios</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-sm table-bordered mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 170px;">Fecha</th>
                  <th style="width: 180px;">Usuario</th>
                  <th>Comentario</th>
                </tr>
              </thead>
              <tbody id="tbody-comentarios-ticket">
                <tr>
                  <td colspan="3" class="text-center text-muted py-3">
                    Cargando comentarios...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: NUEVO COMENTARIO -->
  <div class="modal fade" id="modalNuevoComentarioTicket" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalNuevoComentarioTitulo">Agregar comentario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="txtNuevoComentario" class="form-label fw-semibold">Comentario:</label>
            <textarea id="txtNuevoComentario" class="form-control" rows="4"
                      placeholder="Escribe tu comentario sobre este ticket..."></textarea>
          </div>
          <div id="nuevoComentarioError" class="text-danger small d-none">
            Debes escribir un comentario.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" type="button" onclick="guardarNuevoComentarioTicket()">
            Guardar comentario
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
let todosLosTickets = [];
let modalComentarios;
let modalNuevoComentario;
let ticketIdParaNuevoComentario = null;

document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('token');

  if (!token) {
    alert('Tu sesiÃ³n ha expirado. Vuelve a iniciar sesiÃ³n.');
    window.location.href = 'login.html';
    return;
  }

  // Instanciar modales Bootstrap
  const modalComentariosEl = document.getElementById('modalComentariosTicket');
  if (modalComentariosEl) modalComentarios = new bootstrap.Modal(modalComentariosEl);

  const modalNuevoComentarioEl = document.getElementById('modalNuevoComentarioTicket');
  if (modalNuevoComentarioEl) modalNuevoComentario = new bootstrap.Modal(modalNuevoComentarioEl);

  // Cargar tickets
  cargarMisTickets(token);

  // Filtro
  const selectEstado = document.getElementById('filtro-estado');
  if (selectEstado) selectEstado.addEventListener('change', aplicarFiltro);
});

async function cargarMisTickets(token) {
  const tbody = document.getElementById('tbody-mis-tickets');

  try {
    const resp = await fetch('/api/tickets/mis-tickets', {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });

    if (resp.status === 401) {
      alert('Tu sesiÃ³n no es vÃ¡lida, vuelve a iniciar sesiÃ³n.');
      window.location.href = 'login.html';
      return;
    }

    if (!resp.ok) {
      tbody.innerHTML = `
        <tr><td colspan="7" class="text-center text-danger py-4">
          Error al obtener tus tickets.
        </td></tr>`;
      return;
    }

    const data = await resp.json();
    todosLosTickets = data.tickets || [];

    if (!todosLosTickets.length) {
      tbody.innerHTML = `
        <tr><td colspan="7" class="text-center text-muted py-4">
          No has creado ningÃºn ticket todavÃ­a.
        </td></tr>`;
      return;
    }

    aplicarFiltro();
  } catch (err) {
    console.error('Error al cargar mis tickets:', err);
    tbody.innerHTML = `
      <tr><td colspan="7" class="text-center text-danger py-4">
        OcurriÃ³ un error inesperado al cargar tus tickets.
      </td></tr>`;
  }
}

/* âœ… Estado visible para el usuario
   - Si estatus = Rechazado -> "Rechazado"
   - Si archivado = true y NO rechazado -> "Archivado"
   - si no -> estatus normal
*/
function getEstadoVisible(t) {
  if ((t.estatus || '') === 'Rechazado') return 'Rechazado';
  if (t.archivado) return 'Archivado';
  return t.estatus || 'â€”';
}

function aplicarFiltro() {
  const tbody = document.getElementById('tbody-mis-tickets');
  const selectEstado = document.getElementById('filtro-estado');
  if (!tbody) return;

  const estadoSeleccionado = selectEstado ? selectEstado.value : '';

  let filtrados = todosLosTickets;

  if (estadoSeleccionado) {
    filtrados = todosLosTickets.filter(t => getEstadoVisible(t) === estadoSeleccionado);
  }

  if (!filtrados.length) {
    tbody.innerHTML = `
      <tr><td colspan="7" class="text-center text-muted py-4">
        No hay tickets con el estado seleccionado.
      </td></tr>`;
    return;
  }

  renderTabla(filtrados);
}

function renderTabla(tickets) {
  const tbody = document.getElementById('tbody-mis-tickets');
  if (!tbody) return;

  tbody.innerHTML = '';

  tickets.forEach(t => {
    const estado = getEstadoVisible(t);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="fw-semibold">${t.folio || 'â€”'}</td>
      <td>${renderEstado(estado)}</td>
      <td>${formatearFecha(t.fechaCreacion)}</td>
      <td>${formatearFecha(t.fechaInicio)}</td>
      <td>${formatearFecha(t.fechaCierre)}</td>
      <td>${escapeHtml(t.descripcion || '')}</td>
      <td class="text-center">
        <div class="d-grid gap-1">
          <button class="btn btn-sm btn-dark" type="button"
                  onclick="abrirComentariosTicket('${t._id}')">
            Comentarios
          </button>
          <button class="btn btn-sm btn-warning" type="button"
                  onclick="abrirModalNuevoComentarioTicket('${t._id}')">
            Agregar comentario
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function formatearFecha(fechaIso) {
  if (!fechaIso) return '<span class="text-muted">â€”</span>';

  const d = new Date(fechaIso);
  if (isNaN(d.getTime())) return '<span class="text-muted">â€”</span>';

  const dia  = String(d.getDate()).padStart(2, '0');
  const mes  = String(d.getMonth() + 1).padStart(2, '0');
  const anio = d.getFullYear();
  const horas = String(d.getHours()).padStart(2, '0');
  const mins  = String(d.getMinutes()).padStart(2, '0');

  return `${dia}/${mes}/${anio} ${horas}:${mins}`;
}

function renderEstado(estado) {
  if (!estado) return '<span class="badge bg-secondary badge-estado">â€”</span>';

  let clase = 'secondary';
  const txt = String(estado).toLowerCase();

  if (txt === 'abierto') clase = 'warning';
  else if (txt === 'en proceso') clase = 'info';
  else if (txt === 'en espera de material') clase = 'secondary';
  else if (txt === 'resuelto') clase = 'success';
  else if (txt === 'tiempo excedido') clase = 'danger';
  else if (txt === 'cerrado') clase = 'dark';
  else if (txt === 'archivado') clase = 'secondary';
  else if (txt === 'rechazado') clase = 'warning';

  return `<span class="badge bg-${clase} badge-estado">${estado}</span>`;
}

function escapeHtml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

/* ================================
   MODAL DE COMENTARIOS (solo lectura)
   GET /api/tickets/:id/comentarios-admin
   ================================ */
async function abrirComentariosTicket(ticketId) {
  const ticket = todosLosTickets.find(t => t._id === ticketId);

  const tituloEl = document.getElementById('modalComentariosTitulo');
  const tbody = document.getElementById('tbody-comentarios-ticket');

  if (tituloEl && ticket) {
    const tipo = ticket.tipo || '';
    tituloEl.textContent = `Comentarios â€“ ${ticket.folio || ''}${tipo ? ` (${tipo})` : ''}`;
  }

  if (tbody) {
    tbody.innerHTML = `
      <tr><td colspan="3" class="text-center text-muted py-3">
        Cargando comentarios...
      </td></tr>`;
  }

  if (modalComentarios) modalComentarios.show();

  try {
    const token = localStorage.getItem('token');
    const resp = await fetch(`/api/tickets/${ticketId}/comentarios-admin`, {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });

    if (!resp.ok) {
      if (tbody) {
        tbody.innerHTML = `
          <tr><td colspan="3" class="text-center text-danger py-3">
            Error al cargar comentarios.
          </td></tr>`;
      }
      return;
    }

    const comentarios = await resp.json();

    if (!comentarios.length) {
      if (tbody) {
        tbody.innerHTML = `
          <tr><td colspan="3" class="text-center text-muted py-3">
            No hay comentarios para este ticket.
          </td></tr>`;
      }
      return;
    }

    if (!tbody) return;

    tbody.innerHTML = '';

    comentarios.forEach(c => {
      const fecha = formatearFecha(c.fecha);
      const usuario = c.usuarioNombre || 'â€”';
      const texto = escapeHtml(c.texto || '');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fecha}</td>
        <td>${usuario}</td>
        <td>${texto}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error('Error al cargar comentarios:', err);
    if (tbody) {
      tbody.innerHTML = `
        <tr><td colspan="3" class="text-center text-danger py-3">
          OcurriÃ³ un error al cargar los comentarios.
        </td></tr>`;
    }
  }
}

/* ================================
   MODAL NUEVO COMENTARIO
   POST /api/tickets/:id/comentarios-admin
   ================================ */
function abrirModalNuevoComentarioTicket(ticketId) {
  ticketIdParaNuevoComentario = ticketId;

  const ticket = todosLosTickets.find(t => t._id === ticketId);
  const tituloEl = document.getElementById('modalNuevoComentarioTitulo');
  const txt = document.getElementById('txtNuevoComentario');
  const msgError = document.getElementById('nuevoComentarioError');

  if (tituloEl && ticket) {
    const tipo = ticket.tipo || '';
    tituloEl.textContent = `Agregar comentario â€“ ${ticket.folio || ''}${tipo ? ` (${tipo})` : ''}`;
  }

  if (txt) txt.value = '';
  if (msgError) msgError.classList.add('d-none');

  if (modalNuevoComentario) modalNuevoComentario.show();
}

async function guardarNuevoComentarioTicket() {
  const txt = document.getElementById('txtNuevoComentario');
  const msgError = document.getElementById('nuevoComentarioError');

  if (!ticketIdParaNuevoComentario) return;

  const texto = (txt?.value || '').trim();
  if (!texto) {
    if (msgError) msgError.classList.remove('d-none');
    return;
  } else {
    if (msgError) msgError.classList.add('d-none');
  }

  try {
    const token = localStorage.getItem('token');
    const resp = await fetch(`/api/tickets/${ticketIdParaNuevoComentario}/comentarios-admin`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ texto })
    });

    if (!resp.ok) {
      alert('No se pudo guardar el comentario.');
      return;
    }

    if (modalNuevoComentario) modalNuevoComentario.hide();

    if (modalComentarios) {
      abrirComentariosTicket(ticketIdParaNuevoComentario);
    }

    alert('Comentario guardado correctamente.');
  } catch (err) {
    console.error('Error al guardar comentario:', err);
    alert('OcurriÃ³ un error al guardar el comentario.');
  }
}
</script>

<script src="js/navbar.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

