<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Crear Ticket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap (usa el que ya manejas en tu plantilla) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <!-- TU NAVBAR AQUÍ (si lo tienes con navbar.js se inyecta solo) -->

  <div class="container py-4" style="max-width: 900px;">
    <h2 class="text-center mb-4">Crear Ticket</h2>

    <!-- Área -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Área</label>
      <div class="d-flex gap-3">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="area" id="areaSistemas" value="sistemas" checked>
          <label class="form-check-label" for="areaSistemas">Sistemas (Soporte)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="area" id="areaMantenimiento" value="mantenimiento">
          <label class="form-check-label" for="areaMantenimiento">Mantenimiento (General)</label>
        </div>
      </div>
    </div>

    <!-- Contexto para Sistemas -->
    <div id="wrap-contexto" class="mb-3">
      <label class="form-label fw-semibold">Tipo de solicitud en Sistemas</label>
      <select id="contextoSistemas" class="form-select">
        <option value="laboratorio">Laboratorio de Cómputo</option>
        <option value="otro">Otro (fuera de laboratorio)</option>
      </select>
    </div>

    <!-- Sección: Sistemas / Laboratorio -->
    <div id="wrap-sis-lab" class="card card-body mb-3">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Laboratorio</label>
          <select id="lab" class="form-select">
            <option value="">Selecciona...</option>
            <option>Laboratorio A</option>
            <option>Laboratorio B</option>
            <option>Laboratorio C</option>
            <option>Laboratorio D</option>
            <option>Laboratorio de Química</option>
            <option>Audiovisual</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Equipo (Etiqueta)</label>
          <input id="equipo" class="form-control" placeholder="Ej. PC-03">
        </div>
        <div class="col-12">
          <label class="form-label">Tipo de falla (Sistemas / Laboratorio)</label>
          <select id="tipoFallaSisLab" class="form-select"></select>
        </div>
      </div>
    </div>

    <!-- Sección: Sistemas / Otro -->
    <div id="wrap-sis-otro" class="card card-body mb-3 d-none">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Ubicación</label>
          <input id="ubicacionOtro" class="form-control" placeholder="Ej. Dirección, Biblioteca, etc.">
        </div>
        <div class="col-md-6">
          <label class="form-label">Tipo de falla (Sistemas / Otros)</label>
          <select id="tipoFallaSisOtro" class="form-select"></select>
        </div>
      </div>
    </div>

    <!-- Sección: Mantenimiento -->
    <div id="wrap-mant" class="card card-body mb-3 d-none">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Salón / Área</label>
          <input id="salon" class="form-control" placeholder="Ej. A1, A2, B3, Patio, Oficina, etc.">
          <!-- Más adelante lo cambiamos por un <select> con tu catálogo completo -->
        </div>
        <div class="col-md-6">
          <label class="form-label">Tipo de falla (Mantenimiento)</label>
          <select id="tipoFallaMant" class="form-select"></select>
        </div>
      </div>
    </div>

    <!-- Descripción -->
    <div class="mb-3">
      <label class="form-label">Descripción detallada</label>
      <textarea id="descripcion" class="form-control" rows="4" placeholder="Cuéntanos el problema con detalle..."></textarea>
    </div>

    <div class="d-grid">
      <button id="btnEnviar" class="btn btn-primary btn-lg">Enviar Ticket</button>
    </div>
  </div>

  <script>
    // ===== Catálogos rápidos (luego podemos cargarlos desde BD) =====
    const CATALOGOS = {
      sistemasLab: [
        "No enciende",
        "Sin imagen / monitor",
        "Sin internet (solo en ese equipo)",
        "Teclado / mouse fallando",
        "No imprime",
        "Software no abre",
        "Otra (especificar en la descripción)"
      ],
      sistemasOtro: [
        "No tengo internet (área/oficina)",
        "Formateo / reinstalación",
        "Correo / Office 365",
        "Impresora compartida",
        "Problema con proyector",
        "Otra (especificar en la descripción)"
      ],
      mantenimiento: [
        "No funciona aire acondicionado",
        "No hay luz eléctrica",
        "Contacto dañado / apagador",
        "Vidrio/puerta dañada",
        "Silla / mesa rota",
        "Fuga de agua",
        "Otra (especificar en la descripción)"
      ]
    };

    function llenarOpciones(select, items) {
      select.innerHTML = '<option value="">Selecciona...</option>' +
        items.map(x => `<option>${x}</option>`).join('');
    }

    // Inicialización de combos
    llenarOpciones(document.getElementById('tipoFallaSisLab'), CATALOGOS.sistemasLab);
    llenarOpciones(document.getElementById('tipoFallaSisOtro'), CATALOGOS.sistemasOtro);
    llenarOpciones(document.getElementById('tipoFallaMant'), CATALOGOS.mantenimiento);

    // ===== Lógica de UI =====
    const areaRadios = document.querySelectorAll('input[name="area"]');
    const wrapContexto = document.getElementById('wrap-contexto');
    const contextoSistemas = document.getElementById('contextoSistemas');

    const wrapSisLab = document.getElementById('wrap-sis-lab');
    const wrapSisOtro = document.getElementById('wrap-sis-otro');
    const wrapMant = document.getElementById('wrap-mant');

    function refrescarUI() {
      const area = [...areaRadios].find(r => r.checked).value;

      if (area === 'sistemas') {
        wrapContexto.classList.remove('d-none');
        wrapMant.classList.add('d-none');

        const ctx = contextoSistemas.value;
        wrapSisLab.classList.toggle('d-none', ctx !== 'laboratorio');
        wrapSisOtro.classList.toggle('d-none', ctx !== 'otro');

      } else { // mantenimiento
        wrapContexto.classList.add('d-none');
        wrapSisLab.classList.add('d-none');
        wrapSisOtro.classList.add('d-none');
        wrapMant.classList.remove('d-none');
      }
    }

    areaRadios.forEach(r => r.addEventListener('change', refrescarUI));
    contextoSistemas.addEventListener('change', refrescarUI);
    refrescarUI();

    // ===== Envío =====
    document.getElementById('btnEnviar').addEventListener('click', async () => {
      const area = [...areaRadios].find(r => r.checked).value;
      const descripcion = document.getElementById('descripcion').value.trim();

      // Payload base
      const payload = {
        area,                  // 'sistemas' | 'mantenimiento'
        tipo: null,            // 'laboratorio' | 'otro' (solo para sistemas)
        laboratorio: null,
        equipo: null,
        ubicacion: null,
        salon: null,
        tipoFalla: null,
        descripcion
      };

      if (area === 'sistemas') {
        const ctx = contextoSistemas.value; // 'laboratorio' | 'otro'
        payload.tipo = ctx;

        if (ctx === 'laboratorio') {
          payload.laboratorio = document.getElementById('lab').value || null;
          payload.equipo = document.getElementById('equipo').value.trim() || null;
          payload.tipoFalla = document.getElementById('tipoFallaSisLab').value || null;

          if (!payload.laboratorio) return alert('Selecciona un laboratorio');
          if (!payload.equipo) return alert('Escribe la etiqueta del equipo');
          if (!payload.tipoFalla) return alert('Selecciona el tipo de falla');

        } else { // otro
          payload.ubicacion = document.getElementById('ubicacionOtro').value.trim() || null;
          payload.tipoFalla = document.getElementById('tipoFallaSisOtro').value || null;

          if (!payload.ubicacion) return alert('Indica la ubicación');
          if (!payload.tipoFalla) return alert('Selecciona el tipo de falla');
        }

      } else { // mantenimiento
        payload.salon = document.getElementById('salon').value.trim() || null;
        payload.tipoFalla = document.getElementById('tipoFallaMant').value || null;

        if (!payload.salon) return alert('Indica el salón o área');
        if (!payload.tipoFalla) return alert('Selecciona el tipo de falla');
      }

      if (!descripcion) return alert('Describe el problema');

      try {
        const res = await fetch('/api/tickets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // si usas cookie de sesión; si usas Bearer, agrega Authorization
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || 'No se pudo crear el ticket');
        }
        alert('✅ Ticket creado');
        // Limpieza rápida
        document.getElementById('descripcion').value = '';
      } catch (err) {
        console.error(err);
        alert('❌ Error: ' + err.message);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
