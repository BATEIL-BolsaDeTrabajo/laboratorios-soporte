<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Trabajo - Soporte / Mantenimiento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <!-- Contenedor para insertar el navbar -->
<div id="navbar-container"></div>


  <!-- CONTENIDO -->
  <div class="container py-4">
    <h2 class="text-center mb-4">Panel de Trabajo</h2>
    <div id="tickets" class="row g-3"></div>
  </div>

  <!-- SCRIPTS -->
  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("usuario");
      window.location.href = "login.html";
    }

    const estatusColor = {
      "Abierto": { border: "success", bg: "bg-success-subtle", text: "text-dark" },
      "En proceso": { border: "warning", bg: "bg-warning-subtle", text: "text-dark" },
      "Resuelto": { border: "danger", bg: "bg-danger-subtle", text: "text-dark" },
      "Cerrado": { border: "dark", bg: "bg-dark", text: "text-white" }
    };

    async function cargarTickets() {
      const res = await fetch("/api/tickets", {
        headers: { Authorization: `Bearer ${token}` }
      });

      const datos = await res.json();
      const contenedor = document.getElementById("tickets");
      contenedor.innerHTML = "";

      datos.forEach(ticket => {
        const esCerrado = ticket.estatus === "Cerrado";
        const div = document.createElement("div");
        div.className = "col-md-6 mb-3";

        const estilo = estatusColor[ticket.estatus] || { border: "secondary", bg: "bg-light", text: "text-dark" };

        div.innerHTML = `
          <div class="card border-${estilo.border} ${estilo.bg} ${estilo.text}">
            <div class="card-body">
              <h5 class="card-title">Área: ${ticket.tipo}</h5>
              <p class="card-text">
                Descripción: ${ticket.descripcion}<br>
                Estado: <strong>${ticket.estatus}</strong><br>
                Creado por: ${ticket.creadoPor?.nombre || "Desconocido"}<br>
                Asignado a: ${ticket.asignadoA?.nombre || "Sin asignar"}
              </p>

              <label class="form-label">Estatus:</label>
              <select class="form-select mb-2" id="estatus-${ticket._id}" ${esCerrado ? "disabled" : ""}>
                <option ${ticket.estatus === "Abierto" ? "selected" : ""}>Abierto</option>
                <option ${ticket.estatus === "En proceso" ? "selected" : ""}>En proceso</option>
                <option ${ticket.estatus === "Resuelto" ? "selected" : ""}>Resuelto</option>
                <option ${ticket.estatus === "Cerrado" ? "selected" : ""}>Cerrado</option>
              </select>

              <label class="form-label">Requiere material:</label>
              <input type="text" id="material-${ticket._id}" class="form-control mb-2"
                placeholder="Material requerido (opcional)"
                value="${ticket.requiereMaterial || ''}" ${esCerrado ? "disabled" : ""} />

              <button class="btn btn-primary w-100 mb-2" onclick="actualizarTicket('${ticket._id}')" ${esCerrado ? "disabled" : ""}>
                Guardar cambios
              </button>

              ${!ticket.asignadoA && !esCerrado ? `
                <button class="btn btn-success w-100" onclick="asignarmeTicket('${ticket._id}')">
                  Asignarme
                </button>` : ""
              }
            </div>
          </div>
        `;

        contenedor.appendChild(div);
      });
    }

    async function actualizarTicket(id) {
      const estatus = document.getElementById(`estatus-${id}`).value;
      const requiereMaterial = document.getElementById(`material-${id}`).value;

      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ estatus, requiereMaterial })
      });

      const data = await res.json();
      alert(data.mensaje);
      cargarTickets();
    }

    async function asignarmeTicket(id) {
      const res = await fetch(`/api/tickets/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ asignar: true })
      });

      const data = await res.json();
      alert(data.mensaje);
      cargarTickets();
    }

    cargarTickets();
  </script>
  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>