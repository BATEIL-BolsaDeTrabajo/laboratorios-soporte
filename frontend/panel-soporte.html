<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Trabajo ‚Äì Soporte & Mantenimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <div id="navbar-container"></div>

  <div class="container py-4">
    <h2 class="text-center mb-4">Panel de Trabajo</h2>

    <!-- ======== PANEL SOPORTE (Sistemas) ======== -->
    <section id="sec-soporte" class="mb-5">
      <h4 class="mb-3">üñ•Ô∏è Soporte (Sistemas)</h4>

      <div class="text-center mb-2">
        <span class="fs-6 fw-semibold">‚è±Ô∏è Tiempo promedio de resoluci√≥n:
          <span id="kpiS-tiempo">--</span>
        </span>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-primary text-white">
            <div class="fw-semibold">Total</div>
            <div id="kpiS-total" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-danger text-white">
            <div class="fw-semibold">Abiertos</div>
            <div id="kpiS-abiertos" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-warning text-dark">
            <div class="fw-semibold">En proceso</div>
            <div id="kpiS-proceso" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-info text-dark">
            <div class="fw-semibold">Resueltos</div>
            <div id="kpiS-resueltos" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-success text-white">
            <div class="fw-semibold">Cerrados</div>
            <div id="kpiS-cerrados" class="fs-2">0</div>
          </div>
        </div>
      </div>

      <div id="tickets-soporte" class="row g-3"></div>
    </section>

    <hr>

    <!-- ======== PANEL MANTENIMIENTO (General) ======== -->
    <section id="sec-mantenimiento" class="mt-5">
      <h4 class="mb-3">üîß Mantenimiento (General)</h4>

      <div class="text-center mb-2">
        <span class="fs-6 fw-semibold">‚è±Ô∏è Tiempo promedio de resoluci√≥n:
          <span id="kpiM-tiempo">--</span>
        </span>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-primary text-white">
            <div class="fw-semibold">Total</div>
            <div id="kpiM-total" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-danger text-white">
            <div class="fw-semibold">Abiertos</div>
            <div id="kpiM-abiertos" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-warning text-dark">
            <div class="fw-semibold">En proceso</div>
            <div id="kpiM-proceso" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-info text-dark">
            <div class="fw-semibold">Resueltos</div>
            <div id="kpiM-resueltos" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="p-3 text-center rounded-3 shadow-sm bg-success text-white">
            <div class="fw-semibold">Cerrados</div>
            <div id="kpiM-cerrados" class="fs-2">0</div>
          </div>
        </div>
      </div>

      <div id="tickets-mantenimiento" class="row g-3"></div>
    </section>
  </div>

  <script>
    // ================== CONFIGURACI√ìN B√ÅSICA ==================
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    const ESTILOS = {
      "Abierto":   { border: "danger",  bg: "bg-danger-subtle",  text: "text-dark" },
      "En proceso":{ border: "warning", bg: "bg-warning-subtle", text: "text-dark" },
      "Resuelto":  { border: "info",    bg: "bg-info-subtle",    text: "text-dark" },
      "Cerrado":   { border: "success", bg: "bg-success",        text: "text-white" }
    };

    // Obtener roles desde localStorage o token
    function rolesActuales() {
      try {
        const u = JSON.parse(localStorage.getItem('usuario') || '{}');
        let r = Array.isArray(u.roles) ? u.roles : (u.rol ? [u.rol] : []);
        if (!r.length) {
          const t = localStorage.getItem('token');
          if (t && t.split('.').length === 3) {
            const p = JSON.parse(atob(t.split('.')[1]));
            r = Array.isArray(p.roles) ? p.roles : (p.rol ? [p.rol] : []);
          }
        }
        return r.filter(Boolean).map(x => String(x).trim().toLowerCase());
      } catch { return []; }
    }
    function esAdminActual() {
      return rolesActuales().includes('admin');
    }

    // Ocultar panel seg√∫n rol
    function ajustarPanelesPorRol() {
      const roles = rolesActuales();
      const esAdmin = roles.includes('admin');
      const tieneSoporte = roles.includes('soporte');
      const tieneMant = roles.includes('mantenimiento');

      if (esAdmin || (tieneSoporte && tieneMant)) return;
      if (tieneSoporte) document.getElementById('sec-mantenimiento').classList.add('d-none');
      if (tieneMant) document.getElementById('sec-soporte').classList.add('d-none');
    }

    ajustarPanelesPorRol();

    // ================== FUNCIONES DE C√ÅLCULO ==================
    const fmtPromedio = (ms) => {
      if (!ms || !isFinite(ms)) return "--";
      const mins = Math.round(ms/60000);
      const h = Math.floor(mins/60);
      const m = mins%60;
      return `${h}h ${m}m`;
    };

    function pintarKPIs(tickets, prefijo){
      const total     = tickets.length;
      const abiertos  = tickets.filter(t=>t.estatus==="Abierto").length;
      const proceso   = tickets.filter(t=>t.estatus==="En proceso").length;
      const resueltos = tickets.filter(t=>t.estatus==="Resuelto").length;
      const cerrados  = tickets.filter(t=>t.estatus==="Cerrado").length;

      const terminados = tickets.filter(t => t.fechaCierre || t.estatus==="Cerrado" || t.estatus==="Resuelto");
      let prom = 0;
      if (terminados.length){
        const sum = terminados.reduce((acc,t)=>{
          const ini = new Date(t.fechaCreacion || t.createdAt).getTime();
          const fin = new Date(t.fechaCierre || t.updatedAt || t.createdAt).getTime();
          const d = fin - ini;
          return d>0 ? acc + d : acc;
        },0);
        prom = sum / terminados.length;
      }

      document.getElementById(`${prefijo}-total`).textContent     = total;
      document.getElementById(`${prefijo}-abiertos`).textContent  = abiertos;
      document.getElementById(`${prefijo}-proceso`).textContent   = proceso;
      document.getElementById(`${prefijo}-resueltos`).textContent = resueltos;
      document.getElementById(`${prefijo}-cerrados`).textContent  = cerrados;
      document.getElementById(`${prefijo}-tiempo`).textContent    = fmtPromedio(prom);
    }

    function renderTarjetas(tickets, contId){
      const cont = document.getElementById(contId);
      cont.innerHTML = "";
      const esAdmin = esAdminActual();

      tickets.forEach(t=>{
        const esCerrado = t.estatus === "Cerrado";
        const e = ESTILOS[t.estatus] || { border:"secondary", bg:"bg-light", text:"text-dark" };
        const opciones = esAdmin
          ? ["Abierto","En proceso","Resuelto","Cerrado"]
          : ["Abierto","En proceso","Resuelto"];

        const div = document.createElement("div");
        div.className = "col-md-6";
        div.innerHTML = `
          <div class="card border-${e.border} ${e.bg} ${e.text}">
            <div class="card-body">
              <h5 class="card-title mb-2">√Årea: ${t.tipo}</h5>
              <p class="card-text">
                <strong>Descripci√≥n:</strong> ${t.descripcion}<br>
                <strong>Estado:</strong> ${t.estatus}<br>
                <strong>Creado por:</strong> ${t.creadoPor?.nombre || "‚Äî"}<br>
                <strong>Asignado a:</strong> ${t.asignadoA?.nombre || "Sin asignar"}
              </p>

              <label class="form-label">Estatus:</label>
              <select class="form-select mb-2" id="estatus-${t._id}" ${esCerrado?"disabled":""}>
                ${opciones.map(o => `<option ${t.estatus===o?"selected":""}>${o}</option>`).join('')}
              </select>

              <label class="form-label">Requiere material:</label>
              <input class="form-control mb-2" id="material-${t._id}" placeholder="Material (opcional)"
                     value="${t.requiereMaterial || ''}" ${esCerrado?"disabled":""} />

              <button class="btn btn-primary w-100 mb-2" onclick="actualizarTicket('${t._id}')" ${esCerrado?"disabled":""}>
                Guardar cambios
              </button>

              ${!t.asignadoA && !esCerrado ? `
                <button class="btn btn-success w-100" onclick="asignarmeTicket('${t._id}')">Asignarme</button>` : ""
              }
            </div>
          </div>`;
        cont.appendChild(div);
      });
    }

    async function actualizarTicket(id){
      const estatus = document.getElementById(`estatus-${id}`).value;
      const requiereMaterial = document.getElementById(`material-${id}`).value;
      const res = await fetch(`/api/tickets/${id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify({ estatus, requiereMaterial })
      });
      const data = await res.json();
      alert(data.mensaje || "Actualizado");
      cargar();
    }

    async function asignarmeTicket(id){
      const res = await fetch(`/api/tickets/${id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify({ asignar:true })
      });
      const data = await res.json();
      alert(data.mensaje || "Asignado");
      cargar();
    }

    async function cargar(){
      const res = await fetch("/api/tickets", { headers:{ Authorization:`Bearer ${token}` }});
      const all = await res.json();

      const soporte = (all || []).filter(t => t.tipo === "Sistemas");
      const mant    = (all || []).filter(t => t.tipo === "Mantenimiento");

      pintarKPIs(soporte, "kpiS");
      pintarKPIs(mant, "kpiM");

      renderTarjetas(soporte, "tickets-soporte");
      renderTarjetas(mant, "tickets-mantenimiento");
    }

    cargar();
  </script>

  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
