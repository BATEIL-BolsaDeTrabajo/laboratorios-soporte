<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Trabajo ‚Äì Soporte & Mantenimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <div id="navbar-container"></div>

  <div class="container py-4">
    <h2 class="text-center mb-4">Panel de Trabajo</h2>

    <!-- ======== PANEL SOPORTE (Sistemas) ======== -->
    <section id="sec-soporte" class="mb-5">
      <h4 class="mb-3">üñ•Ô∏è Soporte (Sistemas)</h4>

      <!-- KPIs -->
      <div class="text-center mb-2">
        <span class="fs-6 fw-semibold">‚è±Ô∏è Tiempo promedio de resoluci√≥n:
          <span id="kpiS-tiempo">--</span>
        </span>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-primary text-white">
            <div class="fw-semibold">Total</div>
            <div id="kpiS-total" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-danger text-white">
            <div class="fw-semibold">Abiertos</div>
            <div id="kpiS-abiertos" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-warning text-dark">
            <div class="fw-semibold">En proceso</div>
            <div id="kpiS-proceso" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-success text-white">
            <div class="fw-semibold">Cerrados</div>
            <div id="kpiS-cerrados" class="fs-2">0</div>
          </div>
        </div>
      </div>

      <!-- Tarjetas -->
      <div id="tickets-soporte" class="row g-3"></div>
    </section>

    <hr>

    <!-- ======== PANEL MANTENIMIENTO (General) ======== -->
    <section id="sec-mantenimiento" class="mt-5">
      <h4 class="mb-3">üîß Mantenimiento (General)</h4>

      <!-- KPIs -->
      <div class="text-center mb-2">
        <span class="fs-6 fw-semibold">‚è±Ô∏è Tiempo promedio de resoluci√≥n:
          <span id="kpiM-tiempo">--</span>
        </span>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-primary text-white">
            <div class="fw-semibold">Total</div>
            <div id="kpiM-total" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-danger text-white">
            <div class="fw-semibold">Abiertos</div>
            <div id="kpiM-abiertos" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-warning text-dark">
            <div class="fw-semibold">En proceso</div>
            <div id="kpiM-proceso" class="fs-2">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 text-center rounded-3 shadow-sm bg-success text-white">
            <div class="fw-semibold">Cerrados</div>
            <div id="kpiM-cerrados" class="fs-2">0</div>
          </div>
        </div>
      </div>

      <!-- Tarjetas -->
      <div id="tickets-mantenimiento" class="row g-3"></div>
    </section>
  </div>

  <script>
    // Seguridad b√°sica
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";
    function logout(){ localStorage.removeItem("token"); localStorage.removeItem("usuario"); location.href="login.html"; }

    // Colores por estado
    const ESTILOS = {
      "Abierto":   { border: "danger",  bg: "bg-danger-subtle",  text: "text-dark" },
      "En proceso":{ border: "warning", bg: "bg-warning-subtle", text: "text-dark" },
      "Resuelto":  { border: "success", bg: "bg-success-subtle", text: "text-dark" },
      "Cerrado":   { border: "dark",    bg: "bg-dark",           text: "text-white" }
    };

    const fmtPromedio = (ms) => {
      if (!ms || !isFinite(ms)) return "--";
      const mins = Math.round(ms/60000);
      const h = Math.floor(mins/60);
      const m = mins%60;
      return `${h}h ${m}m`;
    };

    // KPIs por grupo (prefijo 'kpiS' o 'kpiM')
    function pintarKPIs(tickets, prefijo){
      const total    = tickets.length;
      const abiertos = tickets.filter(t=>t.estatus==="Abierto").length;
      const proceso  = tickets.filter(t=>t.estatus==="En proceso").length;
      const cerrados = tickets.filter(t=>t.estatus==="Cerrado").length;

      // promedio usando fechaCreacion -> fechaCierre (o updatedAt si no)
      const cerrables = tickets.filter(t => t.fechaCierre || t.estatus==="Cerrado");
      let prom = 0;
      if (cerrables.length){
        const sum = cerrables.reduce((acc,t)=>{
          const ini = new Date(t.fechaCreacion || t.createdAt).getTime();
          const fin = new Date(t.fechaCierre || t.updatedAt || t.createdAt).getTime();
          const d = fin - ini;
          return d>0 ? acc + d : acc;
        },0);
        prom = sum / cerrables.length;
      }

      document.getElementById(`${prefijo}-total`).textContent    = total;
      document.getElementById(`${prefijo}-abiertos`).textContent = abiertos;
      document.getElementById(`${prefijo}-proceso`).textContent  = proceso;
      document.getElementById(`${prefijo}-cerrados`).textContent = cerrados;
      document.getElementById(`${prefijo}-tiempo`).textContent   = fmtPromedio(prom);
    }

    // Render tarjetas en contenedor dado
    function renderTarjetas(tickets, contId){
      const cont = document.getElementById(contId);
      cont.innerHTML = "";
      tickets.forEach(t=>{
        const esCerrado = t.estatus === "Cerrado";
        const e = ESTILOS[t.estatus] || { border:"secondary", bg:"bg-light", text:"text-dark" };

        const div = document.createElement("div");
        div.className = "col-md-6";
        div.innerHTML = `
          <div class="card border-${e.border} ${e.bg} ${e.text}">
            <div class="card-body">
              <h5 class="card-title mb-2">√Årea: ${t.tipo}</h5>
              <p class="card-text">
                <strong>Descripci√≥n:</strong> ${t.descripcion}<br>
                <strong>Estado:</strong> ${t.estatus}<br>
                <strong>Creado por:</strong> ${t.creadoPor?.nombre || "‚Äî"}<br>
                <strong>Asignado a:</strong> ${t.asignadoA?.nombre || "Sin asignar"}
              </p>

              <label class="form-label">Estatus:</label>
              <select class="form-select mb-2" id="estatus-${t._id}" ${esCerrado?"disabled":""}>
                <option ${t.estatus==="Abierto"?"selected":""}>Abierto</option>
                <option ${t.estatus==="En proceso"?"selected":""}>En proceso</option>
                <option ${t.estatus==="Resuelto"?"selected":""}>Resuelto</option>
                <option ${t.estatus==="Cerrado"?"selected":""}>Cerrado</option>
              </select>

              <label class="form-label">Requiere material:</label>
              <input class="form-control mb-2" id="material-${t._id}" placeholder="Material (opcional)"
                     value="${t.requiereMaterial || ''}" ${esCerrado?"disabled":""} />

              <button class="btn btn-primary w-100 mb-2" onclick="actualizarTicket('${t._id}')" ${esCerrado?"disabled":""}>Guardar cambios</button>
              ${!t.asignadoA && !esCerrado ? `<button class="btn btn-success w-100" onclick="asignarmeTicket('${t._id}')">Asignarme</button>` : ""}
            </div>
          </div>`;
        cont.appendChild(div);
      });
    }

    async function actualizarTicket(id){
      const estatus = document.getElementById(`estatus-${id}`).value;
      const requiereMaterial = document.getElementById(`material-${id}`).value;
      const res = await fetch(`/api/tickets/${id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify({ estatus, requiereMaterial })
      });
      const data = await res.json();
      alert(data.mensaje || "Actualizado");
      cargar(); // recargar para KPIs
    }
    async function asignarmeTicket(id){
      const res = await fetch(`/api/tickets/${id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify({ asignar:true })
      });
      const data = await res.json();
      alert(data.mensaje || "Asignado");
      cargar();
    }

    async function cargar(){
      const res = await fetch("/api/tickets", { headers:{ Authorization:`Bearer ${token}` }});
      const all = await res.json(); // tu backend ya filtra por rol si aplica

      // Separar por tipo
      const soporte = (all || []).filter(t => t.tipo === "Sistemas");
      const mant    = (all || []).filter(t => t.tipo === "Mantenimiento");

      // KPIs
      pintarKPIs(soporte, "kpiS");
      pintarKPIs(mant,    "kpiM");

      // Tarjetas
      renderTarjetas(soporte, "tickets-soporte");
      renderTarjetas(mant,    "tickets-mantenimiento");
    }
function rolesActuales() {
    try {
      const u = JSON.parse(localStorage.getItem('usuario') || '{}');
      let r = Array.isArray(u.roles) ? u.roles : (u.rol ? [u.rol] : []);
      if (!r.length) {
        const t = localStorage.getItem('token');
        if (t && t.split('.').length === 3) {
          const p = JSON.parse(atob(t.split('.')[1]));
          r = Array.isArray(p.roles) ? p.roles : (p.rol ? [p.rol] : []);
        }
      }
      return r.filter(Boolean).map(x => String(x).trim().toLowerCase());
    } catch { return []; }
  }

  function ajustarPanelesPorRol() {
    const roles = rolesActuales();
    const esAdmin = roles.includes('admin');
    const tieneSoporte = roles.includes('soporte');
    const tieneMant = roles.includes('mantenimiento');

    // Si es admin o tiene ambos, mostrar ambos
    if (esAdmin || (tieneSoporte && tieneMant)) return;

    // Mostrar solo el que corresponda
    const secS = document.getElementById('sec-soporte');
    const secM = document.getElementById('sec-mantenimiento');

    if (tieneSoporte && secM) secM.classList.add('d-none');
    if (tieneMant && secS) secS.classList.add('d-none');
  }

  // Llama esto ANTES de cargar datos
  ajustarPanelesPorRol();
    cargar();
  </script>

  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
