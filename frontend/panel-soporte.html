<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel de Soporte / Mantenimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container py-4">
    <h2 class="mb-3">Panel de trabajo</h2>

    <!-- Contenedor donde se insertarán las tarjetas -->
    <div class="row g-3" id="contenedorTickets"></div>
  </div>

  <script>
  // ========= Config & helpers básicos =========
  const API_BASE = ''; // si sirves el front junto al backend, deja vacío
  const token = localStorage.getItem('token');

  function decodeJWT(tk){
    try {
      const payload = tk.split('.')[1];
      return JSON.parse(atob(payload));
    } catch { return null; }
  }

  function esAdminActual(){
    const p = decodeJWT(token);
    if(!p) return false;
    const roles = p.roles || (p.rol ? [p.rol] : []);
    return roles.includes('admin');
  }

  const ESTILOS = {
    "Abierto":     { border:"primary",   bg:"",            text:"" },
    "En proceso":  { border:"warning",   bg:"",            text:"" },
    "Resuelto":    { border:"info",      bg:"",            text:"" },
    "Cerrado":     { border:"success",   bg:"",            text:"" },
    "Cancelado":   { border:"secondary", bg:"",            text:"" }
  };

  function textoUbicacion(t){
    const tipo = (t.tipo || '').toLowerCase();       // 'sistemas' | 'mantenimiento'
    const subtipo = (t.subtipo || '').toLowerCase(); // 'laboratorio' | 'otro' (solo sistemas)

    if (tipo === 'sistemas') {
      if (subtipo === 'laboratorio') {
        const eq = t.equipo ? ` • Equipo: ${t.equipo}` : '';
        return `Laboratorio: ${t.laboratorio || '—'}${eq}`;
      }
      return `Ubicación: ${t.ubicacion || '—'}`;
    }
    if (tipo === 'mantenimiento') {
      return `Salón/Área: ${t.salon || '—'}`;
    }
    return '';
  }

  function badgeEstatus(estatus){
    const map = {
      'Abierto': 'bg-secondary',
      'En proceso': 'bg-warning',
      'Resuelto': 'bg-info',
      'Cerrado': 'bg-success',
      'Cancelado': 'bg-dark'
    };
    const cls = map[estatus] || 'bg-secondary';
    return `<span class="badge ${cls}">${estatus}</span>`;
  }

  // ========= Render de tarjetas =========
  function tarjetaHTML(t){
    const admin = esAdminActual();
    const esC = t.estatus === "Cerrado";
    const esR = t.estatus === "Resuelto";
    const e = ESTILOS[t.estatus] || { border:"secondary", bg:"bg-light", text:"text-dark" };

    // Si no es admin, no puede seleccionar "Cerrado"
    const opciones = admin ? ["Abierto","En proceso","Resuelto","Cerrado"] : ["Abierto","En proceso","Resuelto"];

    return `
      <div class="col-md-6">
        <div class="card border-${e.border} shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h5 class="mb-1">Área: ${t.tipo || '—'}</h5>
                <div class="text-muted small">${textoUbicacion(t)}</div>
              </div>
              <div class="text-end small">
                <div><strong>Estado:</strong> ${badgeEstatus(t.estatus)}</div>
                <div><strong>Creado por:</strong> ${t.creadoPor?.nombre || "—"}</div>
                <div><strong>Asignado a:</strong> ${t.asignadoA?.nombre || "Sin asignar"}</div>
              </div>
            </div>

            <!-- Descripción detallada (solo lectura) -->
            <label class="form-label">Descripción detallada:</label>
            <div class="form-control mb-3" style="min-height:72px; white-space:pre-wrap;">
              ${t.descripcion || "—"}
            </div>

            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label class="form-label">Estatus:</label>
                <select class="form-select" id="estatus-${t._id}" ${esC ? "disabled" : ""}>
                  ${opciones.map(o => `<option ${t.estatus===o?"selected":""}>${o}</option>`).join("")}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Requiere material:</label>
                <textarea class="form-control" id="material-${t._id}" placeholder="Material (opcional)" rows="1" ${esC ? "disabled" : ""}>${t.requiereMaterial || ''}</textarea>
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">Resolución del problema:</label>
              <textarea class="form-control" id="resolucion-${t._id}" rows="2" placeholder="Describe cómo se resolvió" ${esC ? "disabled" : ""}>${t.resolucion || ''}</textarea>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-primary flex-fill" onclick="actualizarTicket('${t._id}')" ${esC ? "disabled" : ""}>Guardar cambios</button>
              <button class="btn btn-success flex-fill" onclick="asignarmeTicket('${t._id}')" ${(esC||esR||t.asignadoA) ? "disabled" : ""}>Asignarme</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderTarjetas(tickets){
    const cont = document.getElementById('contenedorTickets');
    if(!tickets || !tickets.length){
      cont.innerHTML = `<div class="col-12 text-muted">No hay tickets para mostrar.</div>`;
      return;
    }
    cont.innerHTML = tickets.map(tarjetaHTML).join('');
  }

  // ========= Acciones =========
  async function cargar(){
    try{
      const r = await fetch(`${API_BASE}/api/tickets`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await r.json();
      renderTarjetas(data);
    }catch(e){
      console.error(e);
      document.getElementById('contenedorTickets').innerHTML =
        `<div class="col-12 text-danger">No se pudieron cargar los tickets.</div>`;
    }
  }

  async function actualizarTicket(id){
    const estatus = document.getElementById(`estatus-${id}`)?.value;
    const requiereMaterial = document.getElementById(`material-${id}`)?.value || '';
    const resolucion = document.getElementById(`resolucion-${id}`)?.value || '';

    // Validación opcional: pedir resolución al resolver/cerrar
    const admin = esAdminActual();
    if ((estatus === 'Resuelto' || estatus === 'Cerrado') && !resolucion.trim()){
      alert('Para marcar como Resuelto o Cerrado, agrega la resolución del problema.');
      return;
    }
    // Si no eres admin y escogiste "Cerrado" por algún motivo, lo evitamos
    if (!admin && estatus === 'Cerrado'){
      alert('Solo el administrador puede cerrar un ticket.');
      return;
    }

    const r = await fetch(`${API_BASE}/api/tickets/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ estatus, requiereMaterial, resolucion })
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok){
      alert(j.mensaje || j.error || 'No se pudo actualizar el ticket');
      return;
    }
    // feedback opcional
    // alert(j.mensaje || 'Ticket actualizado');
    cargar();
  }

  async function asignarmeTicket(id){
    const r = await fetch(`${API_BASE}/api/tickets/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ asignar: true })
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok){
      alert(j.mensaje || j.error || 'No se pudo asignar el ticket');
      return;
    }
    cargar();
  }

  // ========= Inicio =========
  document.addEventListener('DOMContentLoaded', cargar);
  </script>

  <!-- Bootstrap JS (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
