<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Calificaciones</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div id="navbar-container"></div>
  <div class="container mt-4">
    <div class="card p-4 shadow-sm">
      <h3 class="text-center mb-4">📊 Dashboard de Calificaciones</h3>

      <div class="mb-3 d-flex justify-content-center align-items-center gap-2">
        <label class="form-label mb-0">Periodo:</label>
        <select id="filtro-periodo" class="form-select form-select-sm w-auto"></select>
      </div>

      <div class="bg-light rounded p-3 mb-4 border">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Especialidad</label>
            <select id="filtro-especialidad" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Semestre</label>
            <select id="filtro-semestre" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Grupo</label>
            <select id="filtro-grupo" class="form-select"></select>
          </div>
        </div>
        <div class="d-flex justify-content-center mt-3 gap-3">
          <button id="btn-aplicar" class="btn btn-primary px-4">Aplicar filtros</button>
          <button id="btn-descargar" class="btn btn-success px-4">📥 Descargar Excel</button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-4">
          <h5>Promedio por materia</h5>
          <canvas id="graficoPromedios"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Reprobación por especialidad (%)</h5>
          <canvas id="graficoReprobacion"></canvas>
        </div>
        <div class="col-md-12 mb-4">
          <h5>Top 5 materias con más reprobados</h5>
          <canvas id="graficoTopMaterias"></canvas>
        </div>
        <div class="col-md-12 mb-4">
          <h5>Índice de reprobación por grupo (%)</h5>
          <canvas id="graficoReprobacionGrupo"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    let charts = [];

    async function cargarPeriodos() {
      const res = await fetch('/api/calificaciones/periodos', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const periodos = await res.json();
      const select = document.getElementById('filtro-periodo');
      select.innerHTML = '';
      periodos.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });

      if (periodos.length > 0) {
        select.value = periodos[0];
        await cargarFiltros();
        await cargarEstadisticas();
      }
    }

    async function cargarFiltros() {
      const periodo = document.getElementById('filtro-periodo').value;
      const res = await fetch(`/api/calificaciones/distintos?periodo=${periodo}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      llenarSelect('filtro-especialidad', data.especialidades);
      llenarSelect('filtro-semestre', data.semestres);
      llenarSelect('filtro-grupo', data.grupos);
    }

    function llenarSelect(id, valores) {
      const select = document.getElementById(id);
      select.innerHTML = `<option value="">(Todos)</option>`;
      valores.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    }

    async function cargarEstadisticas() {
      const periodo = document.getElementById('filtro-periodo').value;
      const especialidad = document.getElementById('filtro-especialidad').value;
      const semestre = document.getElementById('filtro-semestre').value;
      const grupo = document.getElementById('filtro-grupo').value;

      const params = new URLSearchParams();
      if (periodo) params.append('periodo', periodo);
      if (especialidad) params.append('especialidad', especialidad);
      if (semestre) params.append('semestre', semestre);
      if (grupo) params.append('grupo', grupo);

      // Promedio por materia
      const res = await fetch(`/api/calificaciones/estadisticas?${params.toString()}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();

      mostrarGrafica('graficoPromedios', 'bar', 'Promedio final',
        data.promedioPorMateria.map(m => m._id),
        data.promedioPorMateria.map(m => m.promedio),
        'rgba(54, 162, 235, 0.6)'
      );

      mostrarGrafica('graficoReprobacion', 'bar', '% Reprobados',
        data.reprobacionPorEspecialidad.map(e => e._id),
        data.reprobacionPorEspecialidad.map(e => e.porcentajeReprobados),
        'rgba(255, 99, 132, 0.6)'
      );

      mostrarGrafica('graficoTopMaterias', 'bar', 'Alumnos reprobados',
        data.topMateriasReprobadas.map(m => m._id),
        data.topMateriasReprobadas.map(m => m.reprobados),
        'rgba(255, 206, 86, 0.6)'
      );

      // Nueva: índice de reprobación por grupo
      const resGrupo = await fetch(`/api/calificaciones/estadisticas/reprobacion-por-grupo?${params.toString()}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const datosGrupo = await resGrupo.json();

      mostrarGrafica('graficoReprobacionGrupo', 'bar', '% Reprobación',
        datosGrupo.map(g => g.grupo),
        datosGrupo.map(g => g.porcentaje),
        'rgba(153, 102, 255, 0.6)'
      );
    }

    function mostrarGrafica(id, tipo, etiqueta, etiquetas, valores, color) {
      const ctx = document.getElementById(id).getContext('2d');
      if (charts[id]) charts[id].destroy();

      charts[id] = new Chart(ctx, {
        type: tipo,
        data: {
          labels: etiquetas,
          datasets: [{
            label: etiqueta,
            data: valores,
            backgroundColor: color
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 100
            }
          }
        }
      });
    }

    document.getElementById('btn-aplicar').addEventListener('click', cargarEstadisticas);

    document.getElementById('btn-descargar').addEventListener('click', () => {
      const periodo = document.getElementById('filtro-periodo').value;
      const especialidad = document.getElementById('filtro-especialidad').value;
      const semestre = document.getElementById('filtro-semestre').value;
      const grupo = document.getElementById('filtro-grupo').value;

      const params = new URLSearchParams();
      if (periodo) params.append('periodo', periodo);
      if (especialidad) params.append('especialidad', especialidad);
      if (semestre) params.append('semestre', semestre);
      if (grupo) params.append('grupo', grupo);

      window.open(`/api/calificaciones/exportar?${params.toString()}&token=${token}`, '_blank');
    });

    cargarPeriodos();
  </script>
  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
