<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Vacaciones - RR.HH.</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div id="navbar-container"></div>


  <div class="container mt-5">

    <div class="mb-4">
      <button class="btn btn-outline-primary me-2" onclick="mostrarSeccion('vacaciones')">üìÑ Vacaciones</button>
      <button class="btn btn-outline-primary me-2" onclick="mostrarSeccion('tiempo')">‚è± Tiempo por Tiempo</button>
      <button class="btn btn-outline-secondary" onclick="mostrarSeccion('ambos')">üëÄ Ver Todo</button>
    </div>

  <div id="seccion-vacaciones" class="mt-5">
    <h2 class="mb-4">üìã Solicitudes de Vacaciones - RR.HH.</h2>
    <div id="mensaje"></div>
   
    <table class="table table-bordered table-hover" id="tablaRRHH">
      <thead class="table-dark">
        <tr>
          <th>Nombre</th>
          <th>Rol</th>
          <th>Fecha inicio</th>
          <th>Fecha fin</th>
          <th>D√≠as</th>
          <th>Estatus</th>
          <th>Motivo respuesta</th>
          <th>D√≠as por pagar</th>
          <th>Formato</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
</div>


 <div id="seccion-tiempo" class="mt-5">
    <hr class="my-5">
    <h2 class="mb-4">‚è± Registros de Tiempo por Tiempo</h2>
    <table class="table table-bordered table-hover" id="tablaTiempoRRHH">
      <thead class="table-dark">
         <tr>
           <th>Docente</th>
           <th>Horas</th>
           <th>Motivo</th>
           <th>Estatus</th>
           <th>Revisado por</th>
           <th>Fecha</th>
           </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

  <script>
    const token = localStorage.getItem('token');
    const tabla = document.querySelector('#tablaRRHH tbody');
    const mensaje = document.getElementById('mensaje');

    async function cargarSolicitudesRRHH() {
      try {
        const res = await fetch('/api/vacaciones/todas', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const datos = await res.json();

        if (!res.ok) {
          mensaje.innerHTML = `<div class="alert alert-danger">‚ùå ${datos.mensaje || 'Error al obtener solicitudes'}</div>`;
          return;
        }

        if (datos.length === 0) {
          tabla.innerHTML = `<tr><td colspan="9" class="text-center">No hay solicitudes.</td></tr>`;
          return;
        }

        datos.forEach(s => {
          const fila = document.createElement('tr');
          const solicitante = s.solicitante?.nombre || '---';
          const rol = s.solicitante?.roles?.[0] || '---';

          fila.innerHTML = `
            <td>${solicitante}</td>
            <td>${rol}</td>
            <td>${new Date(s.fechaInicio).toLocaleDateString()}</td>
            <td>${new Date(s.fechaFin).toLocaleDateString()}</td>
            <td>${s.diasSolicitados}</td>
            <td>
              <span class="badge bg-${s.estatus === 'Aceptado' ? 'success' : s.estatus === 'Rechazado' ? 'danger' : 'warning'}">
                ${s.estatus}
              </span>
            </td>
            <td>${s.motivoRespuesta || '-'}</td>
            <td>${s.diasPorPagar ?? 0}</td>
            <td>
              ${s.estatus === 'Aceptado'
                ? `<button class="btn btn-sm btn-outline-primary" onclick="generarPDF('${s._id}')">Imprimir</button>`
                : ''}
            </td>
          `;

          tabla.appendChild(fila);
        });
      } catch (err) {
        mensaje.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Error de red</div>`;
      }
    }

    function generarPDF(id) {
      window.open(`formato-vacaciones.html?id=${id}`, "_blank");
    }

    //cargarSolicitudesRRHH();

    async function cargarTiempoPorTiempoRRHH() {
  const tabla = document.querySelector('#tablaTiempoRRHH tbody');

  try {
    const res = await fetch('/api/tiempo/todos', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const registros = await res.json();

    if (!res.ok) {
      tabla.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‚ùå ${registros.mensaje || 'Error al obtener registros'}</td></tr>`;
      return;
    }

    if (registros.length === 0) {
      tabla.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Sin registros disponibles.</td></tr>`;
      return;
    }

    registros.forEach(r => {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${r.docente?.nombre || '-'}</td>
        <td>${r.horas}</td>
        <td>${r.motivo || '-'}</td>
        <td><span class="badge bg-${r.estatus === 'Aceptado' ? 'success' : r.estatus === 'Rechazado' ? 'danger' : 'warning'}">${r.estatus}</span></td>
        <td>${r.revisadoPor?.nombre || '-'}</td>
        <td>${new Date(r.fechaRegistro).toLocaleDateString()}</td>
      `;
      tabla.appendChild(fila);
    });
  } catch (err) {
    tabla.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‚ö†Ô∏è Error de red</td></tr>`;
  }
}
//cargarTiempoPorTiempoRRHH();

function mostrarSeccion(tipo) {
  const divVacaciones = document.getElementById('seccion-vacaciones');
  const divTiempo = document.getElementById('seccion-tiempo');

  if (tipo === 'vacaciones') {
    divVacaciones.style.display = 'block';
    divTiempo.style.display = 'none';
  } else if (tipo === 'tiempo') {
    divVacaciones.style.display = 'none';
    divTiempo.style.display = 'block';
  } else {
    divVacaciones.style.display = 'block';
    divTiempo.style.display = 'block';
  }
}

cargarSolicitudesRRHH();
cargarTiempoPorTiempoRRHH();
mostrarSeccion('ambos');

  </script>
  <script src="js/navbar.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
