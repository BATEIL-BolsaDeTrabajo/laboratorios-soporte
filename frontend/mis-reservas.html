<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mis Reservas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div id="navbar-container"></div>
  <div id="navbar-container"></div>

  <div class="container mt-4">
    <h3>📅 Mis Reservas</h3>
    <div id="mensaje" class="mt-2"></div>

    <h5 class="mt-4">Reservas activas</h5>
    <div id="reservas-activas" class="row row-cols-1 row-cols-md-2 g-3"></div>

    <h5 class="mt-4">Historial de reservas pasadas</h5>
    <div id="reservas-pasadas" class="row row-cols-1 row-cols-md-2 g-3"></div>
  </div>

  <script>
    const token = localStorage.getItem("token");

    function generarTarjeta(r, puedeCancelar) {
      const fechaStr = new Date(r.fecha).toLocaleDateString();
      return `
        <div class="col">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">📅 ${fechaStr}</h5>
              <p class="card-text">🕐 ${r.hora}</p>
              <p class="card-text">🧪 ${r.laboratorio}</p>
              ${puedeCancelar ? `<button class="btn btn-danger btn-sm" onclick="cancelar('${r._id}')">Cancelar</button>` : ""}
            </div>
          </div>
        </div>
      `;
    }

    async function cargarReservas() {
      const mensaje = document.getElementById("mensaje");
      mensaje.innerHTML = "";

      try {
        const res = await fetch("/api/horarios/mis-reservas", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const reservas = await res.json();

        const activas = [];
        const pasadas = [];

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        reservas.forEach(r => {
          const fecha = new Date(r.fecha);
          if (fecha >= hoy) activas.push(r);
          else pasadas.push(r);
        });

        const activasCont = document.getElementById("reservas-activas");
        const pasadasCont = document.getElementById("reservas-pasadas");
        activasCont.innerHTML = "";
        pasadasCont.innerHTML = "";

        if (activas.length === 0) {
          activasCont.innerHTML = `<p class="text-muted">No tienes reservas activas.</p>`;
        } else {
          activas.forEach(r => activasCont.innerHTML += generarTarjeta(r, true));
        }

        if (pasadas.length === 0) {
          pasadasCont.innerHTML = `<p class="text-muted">No hay historial de reservas.</p>`;
        } else {
          pasadas.forEach(r => pasadasCont.innerHTML += generarTarjeta(r, false));
        }

      } catch (err) {
        mensaje.innerHTML = `<div class="alert alert-danger">❌ Error al obtener reservas</div>`;
      }
    }

    async function cancelar(id) {
      if (!confirm("¿Cancelar esta reserva?")) return;

      const res = await fetch("/api/horarios/cancelar", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ horarioId: id })
      });

      const data = await res.json();
      if (res.ok) {
        alert("✅ Reserva cancelada");
        cargarReservas();
      } else {
        alert("❌ Error: " + data.mensaje);
      }
    }

    cargarReservas();
  </script>
  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>