<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reservas - Coordinaci√≥n D</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="/js/navbar.js" defer></script>
</head>
<body class="bg-light">
  <div id="navbar-container"></div>

  <div class="container py-4">
    <h2 class="mb-4">üìÖ Reservas de Laboratorios (Coordinaci√≥n D)</h2>

    <!-- Filtros -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label class="form-label">Desde</label>
        <input type="date" id="desde" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Hasta</label>
        <input type="date" id="hasta" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Laboratorio</label>
        <select id="labFilter" class="form-select">
          <option value="">Todos</option>
          <option>Laboratorio A</option>
          <option>Laboratorio B</option>
          <option>Laboratorio C</option>
          <option>Laboratorio D</option>
          <option>Laboratorio de Qu√≠mica</option>
          <option>Audiovisual</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Docente</label>
        <input id="docenteFilter" class="form-control" placeholder="Nombre del docente">
      </div>

      <div class="col-12 d-flex gap-2">
        <button id="btnBuscar" class="btn btn-primary">üîç Buscar</button>
        <button id="btnLimpiar" class="btn btn-outline-secondary">Limpiar filtros</button>
      </div>
    </div>

    <!-- Tabla de reservas -->
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Laboratorio</th>
            <th>Reservado por</th>
            <th>Correo</th>
          </tr>
        </thead>
        <tbody id="tbody-reservas"></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Utilidades de fetch con token ---
    async function fetchJSON(url) {
      const token = localStorage.getItem('token');
      const res = await fetch(url, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    function fmtFecha(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('es-MX', {
        weekday:'short', year:'numeric', month:'2-digit', day:'2-digit'
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Rango inicial: √∫ltimos 7 y pr√≥ximos 7 d√≠as
      const d = new Date();
      const desde = new Date(); desde.setDate(d.getDate() - 7);
      const hasta = new Date(); hasta.setDate(d.getDate() + 7);
      document.getElementById('desde').value = desde.toISOString().slice(0,10);
      document.getElementById('hasta').value = hasta.toISOString().slice(0,10);

      // Eventos
      document.getElementById('btnBuscar').addEventListener('click', cargar);
      document.getElementById('btnLimpiar').addEventListener('click', limpiarFiltros);

      // Actualiza resultados cuando el usuario escribe el nombre del docente
      document.getElementById('docenteFilter').addEventListener('input', aplicarFiltrosLocales);
      document.getElementById('labFilter').addEventListener('change', cargar); // pedimos al backend por lab

      cargar(); // primera carga
    });

    let dataCache = []; // guardamos la respuesta para filtros locales r√°pidos

    async function cargar() {
      try {
        const desde = document.getElementById('desde').value;
        const hasta = document.getElementById('hasta').value;
        const lab = document.getElementById('labFilter').value;

        const q = new URLSearchParams();
        if (desde) q.set('desde', desde);
        if (hasta) q.set('hasta', hasta);
        if (lab)   q.set('laboratorio', lab); // si el backend lo soporta, filtra en servidor

        const url = '/api/horarios/coordinacion?' + q.toString();
        const data = await fetchJSON(url);

        // Guarda en memoria para filtros por docente/laboratorio (fallback cliente)
        dataCache = Array.isArray(data) ? data : [];

        // Aplica filtros locales (docente y, por si el backend no filtr√≥, laboratorio)
        aplicarFiltrosLocales();
      } catch (e) {
        console.error(e);
        alert('‚ùå No se pudieron cargar las reservas.');
      }
    }

    function aplicarFiltrosLocales() {
      const docenteQ = (document.getElementById('docenteFilter').value || '').trim().toLowerCase();
      const lab = document.getElementById('labFilter').value;

      // Filtrado local
      const filtrados = dataCache.filter(r => {
        // Por laboratorio (solo si el backend no lo hizo; igual se puede repetir sin problema)
        const okLab = !lab || (r.laboratorio === lab);

        // Por docente
        const nombre = (r.reservadoPor && r.reservadoPor.nombre) ? r.reservadoPor.nombre : '';
        const okDoc = !docenteQ || nombre.toLowerCase().includes(docenteQ);

        return okLab && okDoc;
      });

      renderTabla(filtrados);
    }

    function renderTabla(rows) {
      const tbody = document.getElementById('tbody-reservas');
      tbody.innerHTML = '';

      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5" class="text-center text-muted">No hay reservas con los filtros seleccionados.</td>';
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(r => {
        const nombre = (r.reservadoPor && r.reservadoPor.nombre) ? r.reservadoPor.nombre : '-';
        const correo = (r.reservadoPor && r.reservadoPor.correo) ? r.reservadoPor.correo : '-';

        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + fmtFecha(r.fecha) + '</td>' +
          '<td>' + r.hora + '</td>' +
          '<td>' + r.laboratorio + '</td>' +
          '<td>' + nombre + '</td>' +
          '<td>' + correo + '</td>';
        tbody.appendChild(tr);
      });
    }

    function limpiarFiltros() {
      document.getElementById('labFilter').value = '';
      document.getElementById('docenteFilter').value = '';
      cargar();
    }
  </script>
  <script src="/socket.io/socket.io.js"></script>
</body>
</html>
