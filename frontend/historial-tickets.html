<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div id="navbar-container"></div>

  <div class="container py-4">
    <h3 class="mb-3">Historial de Tickets</h3>

    <!-- Filtros -->
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <select id="filtro-estado" class="form-select">
          <option value="">Todos los estados</option>
          <option>Abierto</option>
          <option>En proceso</option>
          <option>En espera de material</option>
          <option>Resuelto</option>
          <option>Cerrado</option>
          <option>Tiempo excedido</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="filtro-prioridad" class="form-select">
          <option value="">Todas las prioridades</option>
          <option>Alta</option>
          <option>Media</option>
          <option>Baja</option>
        </select>
      </div>
      <div class="col-md-4">
        <input id="filtro-busqueda" class="form-control" placeholder="Buscar por asignado o creador..." />
      </div>
      <div class="col-md-1 d-grid">
        <button class="btn btn-secondary" onclick="refrescar()">Filtrar</button>
      </div>
      <div class="col-md-1 d-grid">
        <button class="btn btn-outline-secondary" onclick="resetFiltros()">Limpiar</button>
      </div>
    </div>

    <!-- Mensajes -->
    <div id="mensaje-estado" class="mb-3"></div>

    <!-- Tabla resumida -->
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle bg-white">
        <thead class="table-light">
          <tr>
            <th>Folio</th>
            <th>Área</th>
            <th>Asignado</th>
            <th>Creado</th>
            <th>Cierre</th>
            <th>Prioridad</th>
            <th>Estado</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody id="tbody-historial"></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL DETALLES -->
  <div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalles del ticket</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="detalle-meta" class="mb-3 small text-muted"></div>

          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead class="table-light">
                <tr>
                  <th>Fecha evento</th>
                  <th>Cambio</th>
                  <th>Usuario</th>
                  <th>Inicio</th>
                  <th>Reanudación</th>
                  <th>Req. material</th>
                  <th>Tiempo solución</th>
                  <th>Comentarios</th>
                  <th>Material pedido</th>
                  <th>¿Cómo se solucionó?</th>
                </tr>
              </thead>
              <tbody id="tbl-historial"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Navbar
    fetch("/navbar.html").then(r => r.text()).then(h => {
      const c = document.getElementById("navbar-container"); if (c) c.innerHTML = h;
    });

    const token = localStorage.getItem("token");
    if (!token) location.href = "login.html";

    // Persistencia de filtros
    const FK = {
      estado: 'hist_est',
      prioridad: 'hist_pri',
      busqueda: 'hist_q'
    };

    function saveFilters(){
      localStorage.setItem(FK.estado, document.getElementById('filtro-estado').value);
      localStorage.setItem(FK.prioridad, document.getElementById('filtro-prioridad').value);
      localStorage.setItem(FK.busqueda, document.getElementById('filtro-busqueda').value);
    }
    function loadFilters(){
      const e = localStorage.getItem(FK.estado) ?? '';
      const p = localStorage.getItem(FK.prioridad) ?? '';
      const q = localStorage.getItem(FK.busqueda) ?? '';
      document.getElementById('filtro-estado').value = e;
      document.getElementById('filtro-prioridad').value = p;
      document.getElementById('filtro-busqueda').value = q;
    }

    let DATA = [];

    const pad = n => String(n).padStart(2, "0");

    function fmtFecha(d) {
      if (!d) return "—";
      const dt = new Date(d);
      return `${pad(dt.getDate())}/${pad(dt.getMonth() + 1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    }

      // Convierte minutos a "2 días 3 h 15 min" (maneja null/0)
    function fmtMinutos(min) {
      if (min === null || min === undefined) return '—';
      const n = Math.max(0, Math.round(min));
      const dias = Math.floor(n / 1440);
      const horas = Math.floor((n % 1440) / 60);
      const minutos = n % 60;

      const partes = [];
      if (dias)   partes.push(`${dias} ${dias === 1 ? 'día' : 'días'}`);
      if (horas)  partes.push(`${horas} h`);
      if (minutos || partes.length === 0) partes.push(`${minutos} min`);
      return partes.join(' ');
    }



    function badgeEstado(est) {
      const map = {
        "Abierto": "bg-secondary",
        "En proceso": "bg-warning text-dark",
        "En espera de material": "bg-secondary",
        "Resuelto": "bg-info",
        "Cerrado": "bg-success",
        "Tiempo excedido": "bg-danger"
      };
      return `<span class="badge ${map[est] || "bg-secondary"}">${est}</span>`;
    }

    function badgePrioridad(p) {
      const map = { "Alta": "bg-danger", "Media": "bg-warning text-dark", "Baja": "bg-primary","Sin prioridad": "bg-secondary" };
      return `<span class="badge ${map[p] || "bg-warning text-dark"}">${p || "Media"}</span>`;
    }

    function showMsg(texto, tipo='info'){
      const div = document.getElementById('mensaje-estado');
      div.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${texto}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>`;
    }

    async function cargar() {
      loadFilters();
      let r;
      try{
        r = await fetch("/api/tickets/historial", { headers: { Authorization: `Bearer ${token}` } });
      }catch(e){
        showMsg('No se pudo conectar con el servidor.', 'danger');
        return;
      }

      if (r.status === 401) { showMsg('Sesión expirada. Inicia sesión de nuevo.', 'warning'); return; }
      if (r.status === 403) { showMsg('No tienes permisos para ver el historial.', 'warning'); return; }
      if (!r.ok) { showMsg('No se pudo cargar el historial.', 'danger'); return; }

      DATA = await r.json();
      refrescar();
    }

    function pasaFiltros(t) {
      const estado = document.getElementById("filtro-estado").value;
      const prioridad = document.getElementById("filtro-prioridad").value;
      const q = document.getElementById("filtro-busqueda").value.toLowerCase().trim();

      if (estado && t.estatus !== estado) return false;
      if (prioridad && (t.prioridad || "Media") !== prioridad) return false;

      if (q) {
        const asignado = t.asignadoA?.nombre?.toLowerCase() || "";
        const creador = t.creadoPor?.nombre?.toLowerCase() || "";
        if (!(asignado.includes(q) || creador.includes(q))) return false;
      }
      return true;
    }

    function refrescar() {
      saveFilters();
      const tb = document.getElementById("tbody-historial");
      tb.innerHTML = "";
      const rows = DATA.filter(pasaFiltros);

      if (!rows.length){
        tb.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No hay resultados con los filtros actuales.</td></tr>`;
        return;
      }

      rows.forEach(t => {
        tb.innerHTML += `
          <tr>
            <td>${t.folio || "—"}</td>
            <td>${t.tipo || "—"}</td>
            <td>${t.asignadoA?.nombre || "—"}</td>
            <td>${fmtFecha(t.fechaCreacion || t.createdAt)}</td>
            <td>${fmtFecha(t.fechaCierre)}</td>
            <td>${badgePrioridad(t.prioridad)}</td>
            <td>${badgeEstado(t.estatus)}</td>
            <td><button class="btn btn-outline-primary btn-sm" onclick="verDetalles('${t._id}')">Detalles</button></td>
          </tr>
        `;
      });
    }

    function resetFiltros() {
      document.getElementById("filtro-estado").value = "";
      document.getElementById("filtro-prioridad").value = "";
      document.getElementById("filtro-busqueda").value = "";
      refrescar();
    }

    async function verDetalles(id) {
      const headers = { Authorization: `Bearer ${token}` };
      const [tRes, hRes] = await Promise.all([
        fetch(`/api/tickets/${id}`, { headers }),
        fetch(`/api/tickets/${id}/historial`, { headers })
      ]);

      if (!tRes.ok || !hRes.ok){
        showMsg('No se pudieron cargar los detalles del ticket.', 'danger');
        return;
      }

      const t = await tRes.json();
      const hist = await hRes.json();

      document.getElementById("detalle-meta").innerHTML = `
        <div><strong>Folio:</strong> ${t.folio || "—"} | <strong>Área:</strong> ${t.tipo || "—"} | <strong>Estado actual:</strong> ${t.estatus || "—"}</div>
        <div><strong>Creado por:</strong> ${t.creadoPor?.nombre || "—"} | <strong>Asignado a:</strong> ${t.asignadoA?.nombre || "Sin asignar"}</div>
        <div><strong>Creado:</strong> ${fmtFecha(t.fechaCreacion || t.createdAt)} | <strong>Cierre:</strong> ${fmtFecha(t.fechaCierre)} | <strong>Prioridad:</strong> ${t.prioridad || "Media"}</div>
      `;

      const tbody = document.getElementById("tbl-historial");
      tbody.innerHTML = "";
      (hist || []).forEach(h => {
        const ts = fmtMinutos(h.tiempoSolucionMin); // ✅ usamos el nuevo helper
        tbody.innerHTML += `
          <tr>
            <td>${fmtFecha(h.fecha)}</td>
            <td>${(h.de || "—")} → ${(h.a || "—")}</td>
            <td>${h.usuarioNombre || h.usuario?.nombre || "—"}</td>
            <td>${fmtFecha(h.fechaInicio)}</td>
            <td>${fmtFecha(h.fechaReanudacion)}</td>
            <td>${h.requiereMaterial ? "Sí" : "No"}</td>
            <td>${ts}</td>
            <td style="white-space:pre-wrap">${h.comentario || "—"}</td>
            <td style="white-space:pre-wrap">${h.requiereMaterial || "—"}</td>
            <td style="white-space:pre-wrap">${h.resolucion || "—"}</td>
          </tr>
        `;
      });

      // Abrir modal con fallback por si bootstrap aún no está disponible (muy raro)
      const el = document.getElementById("modalDetalles");
      if (window.bootstrap && bootstrap.Modal) {
        new bootstrap.Modal(el).show();
      } else {
        el.classList.add('show');
        el.style.display = 'block';
        el.removeAttribute('aria-hidden');
      }
    }

    // Eventos para persistencia inmediata
    document.getElementById('filtro-estado').addEventListener('change', refrescar);
    document.getElementById('filtro-prioridad').addEventListener('change', refrescar);
    document.getElementById('filtro-busqueda').addEventListener('input', ()=> {
      // simple debounce
      clearTimeout(window.__hist_deb);
      window.__hist_deb = setTimeout(refrescar, 250);
    });

    cargar();
  </script>

  <script src="js/navbar.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

