<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div id="navbar-container"></div>

  <div class="container py-4">
    <h3 class="mb-3">Historial de Tickets</h3>

    <!-- Filtros básicos -->
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <select id="filtro-estado" class="form-select">
          <option value="">Todos los estados</option>
          <option>Abierto</option>
          <option>En proceso</option>
          <option>En espera de material</option>
          <option>Resuelto</option>
          <option>Cerrado</option>
        </select>
      </div>
      <div class="col-md-5">
        <input id="filtro-busqueda" class="form-control" placeholder="Buscar por asignado o creador..." />
      </div>
      <div class="col-md-2">
        <button class="btn btn-secondary w-100" onclick="refrescar()">Filtrar</button>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-secondary w-100" onclick="resetFiltros()">Limpiar</button>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle bg-white">
        <thead class="table-light">
          <tr>
            <th>Folio</th>
            <th>Área</th>
            <th>Asignado</th>
            <th>Creado</th>
            <th>Inicio</th>
            <th>Reanudación</th>
            <th>Cierre</th>
            <th>Req. material</th>
            <th class="text-end">Tiempo de solución</th>
            <th>Prioridad</th>
            <th>Estatus</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody id="tbody-historial"></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL DETALLES -->
  <div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalles del ticket</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="detalle-meta" class="mb-3 small text-muted"></div>

          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead class="table-light">
                <tr>
                  <th>Fecha evento</th>
                  <th>Cambio</th>
                  <th>Usuario</th>
                  <th>Inicio</th>
                  <th>Reanudación</th>
                  <th>Req. material</th>
                  <th>Tiempo solución</th>
                  <th>Comentarios</th>
                  <th>Material pedido</th>
                  <th>¿Cómo se solucionó?</th>
                </tr>
              </thead>
              <tbody id="tbl-historial"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    fetch("/navbar.html").then(r=>r.text()).then(h=>{
      const c=document.getElementById('navbar-container'); if(c) c.innerHTML=h;
    });

    const token = localStorage.getItem('token');
    if(!token) location.href = 'login.html';

    let DATA = [];

    function pad(n){ return String(n).padStart(2,'0'); }
    function fmtFecha(d){
      if(!d) return '—';
      d = new Date(d);
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function fmtDur(ms){
      if(!ms || !isFinite(ms) || ms < 0) return '—';
      const m = Math.round(ms/60000);
      const d = Math.floor(m / (60*24));
      const h = Math.floor((m - d*60*24) / 60);
      const mm= m % 60;
      if (d > 0) return `${d}d ${h}h ${mm}m`;
      if (h > 0) return `${h}h ${mm}m`;
      return `${mm}m`;
    }

    function duracionTicket(t){
      const cierre = t.fechaCierre ? new Date(t.fechaCierre) : new Date();
      const inicioReal = t.fechaReanudacion ? new Date(t.fechaReanudacion)
                        : t.fechaInicio   ? new Date(t.fechaInicio)
                        : t.createdAt     ? new Date(t.createdAt)
                        : null;
      if(!inicioReal) return null;
      return cierre - inicioReal;
    }

    function requiereMat(t){
      return !!(t.requiereMaterial && String(t.requiereMaterial).trim());
    }

    function badgeCls(s){
      const map = {
        'Abierto':'bg-secondary',
        'En proceso':'bg-warning',
        'En espera de material':'bg-secondary',
        'Resuelto':'bg-info',
        'Cerrado':'bg-success'
      };
      return map[s] || 'bg-secondary';
    }

    function pasaFiltros(t){
      const est = document.getElementById('filtro-estado').value;
      const q = document.getElementById('filtro-busqueda').value.toLowerCase().trim();
      if (est && t.estatus !== est) return false;
      if (q){
        const asignado = t.asignadoA?.nombre || '';
        const creador  = t.creadoPor?.nombre || '';
        if (!(asignado.toLowerCase().includes(q) || creador.toLowerCase().includes(q))) return false;
      }
      return true;
    }

    function refrescar(){
      const tbody = document.getElementById('tbody-historial');
      tbody.innerHTML = '';
      DATA.filter(pasaFiltros).forEach(t=>{
        const ms = duracionTicket(t);
        tbody.innerHTML += `
          <tr>
            <td>${t.folio || '—'}</td>
            <td>${t.tipo}</td>
            <td>${t.asignadoA?.nombre || '—'}</td>
            <td>${fmtFecha(t.fechaCreacion || t.createdAt)}</td>
            <td>${fmtFecha(t.fechaInicio)}</td>
            <td>${fmtFecha(t.fechaReanudacion)}</td>
            <td>${fmtFecha(t.fechaCierre)}</td>
            <td>${requiereMat(t) ? 'Sí' : 'No'}</td>
            <td class="text-end">${fmtDur(ms)}</td>
            <td>
              <span class="badge ${
              (t.prioridad==='Alta') ? 'bg-danger'
               : (t.prioridad==='Media') ? 'bg-warning'
               : 'bg-secondary'
              }">${t.prioridad || 'Media'}</span>
            </td>
            <td><span class="badge ${badgeCls(t.estatus)}">${t.estatus}</span></td>
            <td><button class="btn btn-outline-primary btn-sm" onclick="verDetalles('${t._id}')">Detalles</button></td>
          </tr>`;
      });
    }

    function resetFiltros(){
      document.getElementById('filtro-estado').value = '';
      document.getElementById('filtro-busqueda').value = '';
      refrescar();
    }

    async function cargar(){
      const r = await fetch('/api/tickets/historial', { headers: { Authorization:`Bearer ${token}` }});
      if(!r.ok){ alert('No se pudo cargar el historial'); return; }
      DATA = await r.json();
      refrescar();
    }

    async function verDetalles(id){
      const [tRes, hRes] = await Promise.all([
        fetch(`/api/tickets/${id}`, { headers:{ Authorization:`Bearer ${token}` } }),
        fetch(`/api/tickets/${id}/historial`, { headers:{ Authorization:`Bearer ${token}` } })
      ]);
      const t = await tRes.json();
      const hist = await hRes.json();

      const meta = `
        <div><strong>Folio:</strong> ${t.folio || '—'} | <strong>Área:</strong> ${t.tipo} | <strong>Estado actual:</strong> ${t.estatus}</div>
        <div><strong>Creado por:</strong> ${t.creadoPor?.nombre || '—'} | <strong>Asignado a:</strong> ${t.asignadoA?.nombre || 'Sin asignar'}</div>
        <div><strong>Creado:</strong> ${fmtFecha(t.fechaCreacion||t.createdAt)} | <strong>Cierre:</strong> ${fmtFecha(t.fechaCierre)} | <strong>Prioridad:</strong> ${t.prioridad || 'Media'}</div>
      `;
      document.getElementById('detalle-meta').innerHTML = meta;

      const tbody = document.getElementById('tbl-historial');
      tbody.innerHTML = '';
      (hist || []).forEach(h=>{
        const tr = document.createElement('tr');
        const ts = (h.tiempoSolucionMin != null) ? `${h.tiempoSolucionMin} min` : '—';
        tr.innerHTML = `
          <td>${fmtFecha(h.fecha)}</td>
          <td>${(h.de||'—')} → ${(h.a||'—')}</td>
          <td>${h.usuarioNombre || h.usuario?.nombre || '—'}</td>
          <td>${fmtFecha(h.fechaInicio)}</td>
          <td>${fmtFecha(h.fechaReanudacion)}</td>
          <td>${h.requiereMaterial ? 'Sí' : 'No'}</td>
          <td>${ts}</td>
          <td style="white-space:pre-wrap">${h.comentario || '—'}</td>
          <td style="white-space:pre-wrap">${h.requiereMaterial || '—'}</td>
          <td style="white-space:pre-wrap">${h.resolucion || '—'}</td>
        `;
        tbody.appendChild(tr);
      });

      new bootstrap.Modal(document.getElementById('modalDetalles')).show();
    }

    cargar();
  </script>

  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
