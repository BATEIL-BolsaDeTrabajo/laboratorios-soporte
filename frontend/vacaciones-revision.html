<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Revisi√≥n de Vacaciones</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div id="navbar-container"></div>
  <div class="container mt-5">
    <h2 class="mb-4">üßæ Revisi√≥n de Solicitudes de Vacaciones</h2>
    <div id="mensaje"></div>

    <table class="table table-bordered table-hover" id="tablaRevision">
      <thead class="table-dark">
        <tr>
          <th>Nombre</th>
          <th>Rol</th>
          <th>Fechas</th>
          <th>D√≠as</th>
          <th>Motivo</th>
          <th>Revisar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const tabla = document.querySelector('#tablaRevision tbody');
    const mensaje = document.getElementById('mensaje');

    async function cargarPendientes() {
      try {
        const res = await fetch('/api/vacaciones/pendientes', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const datos = await res.json();
        if (!res.ok) {
          mensaje.innerHTML = `<div class="alert alert-danger">‚ùå ${datos.mensaje || 'Error al obtener solicitudes'}</div>`;
          return;
        }

        if (datos.length === 0) {
          tabla.innerHTML = `<tr><td colspan="6" class="text-center">No hay solicitudes pendientes.</td></tr>`;
          return;
        }

        datos.forEach(s => {
          const fila = document.createElement('tr');
          const nombre = s.solicitante?.nombre || '---';
          const rol = s.solicitante?.roles?.[0] || '---';

          fila.innerHTML = `
            <td>${nombre}</td>
            <td>${rol}</td>
            <td>${new Date(s.fechaInicio).toLocaleDateString()}<br>‚Üí ${new Date(s.fechaFin).toLocaleDateString()}</td>
            <td>${s.diasSolicitados}</td>
            <td>${s.motivo || '-'}</td>
            <td>
              <select class="form-select form-select-sm" id="accion-${s._id}">
                <option value="">-- Acci√≥n --</option>
                <option value="Aceptado">‚úÖ Aceptar</option>
                <option value="Rechazado">‚ùå Rechazar</option>
              </select>
              <input type="text" class="form-control form-control-sm mt-1" placeholder="Motivo (opcional)" id="motivo-${s._id}">
              <button class="btn btn-sm btn-primary mt-2" onclick="enviarRevision('${s._id}')">Guardar</button>
            </td>
          `;

          tabla.appendChild(fila);
        });
      } catch (err) {
        mensaje.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Error de red</div>`;
      }
    }

    async function enviarRevision(id) {
      const estatus = document.getElementById(`accion-${id}`).value;
      const motivo = document.getElementById(`motivo-${id}`).value;

      if (!estatus) {
        alert('Selecciona una acci√≥n');
        return;
      }

      try {
        const res = await fetch(`/api/vacaciones/revisar/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ estatus, motivoRespuesta: motivo })
        });

        const data = await res.json();
        if (res.ok) {
          alert('‚úÖ Solicitud actualizada');
          location.reload();
        } else {
          alert(`‚ùå ${data.mensaje || 'Error al actualizar'}`);
        }
      } catch (err) {
        alert('‚ö†Ô∏è Error de red');
      }
    }

    cargarPendientes();
  </script>
  <script src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
